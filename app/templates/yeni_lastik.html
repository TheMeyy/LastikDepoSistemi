{% extends "base.html" %}

{% block title %}Yeni Lastik Depo Girişi - Lastik Depo Sistemi{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Yeni Lastik Depo Girişi</h1>
    <p class="text-gray-600 mb-8">Müşteri seç, lastik bilgilerini ve rafı belirle, sonra depoya kaydet.</p>
    
    <form id="tireForm">
        <!-- Step 1: Customer and Contact Information -->
        <div id="step1" class="mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-6">1. Müşteri ve İletişim Bilgileri</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-1.5">Müşteri Adı / Soyadı *</label>
                        <input type="text" id="customer_name" name="customer_name" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                               required>
                    </div>
                    
                    <div>
                        <label for="customer_plate" class="block text-sm font-medium text-gray-700 mb-1.5">Plaka *</label>
                        <input type="text" id="customer_plate" name="customer_plate" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                               required>
                    </div>
                    
                    <div>
                        <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-1.5">Telefon *</label>
                        <input type="text" id="customer_phone" name="customer_phone" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                               required>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Tire Information -->
        <div id="step2" class="mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-6">2. Lastik Bilgilerini Gir</h2>
                
                <!-- Dynamic Tires Container -->
                <div id="tiresContainer" class="space-y-4 mb-4">
                    <!-- Initial tire will be added by JavaScript -->
                </div>
                
                <!-- Add Tire Button -->
                <div class="flex justify-center mb-6">
                    <button type="button" id="addTireBtn" onclick="addTireField()" 
                            class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>Yeni Lastik Ekle</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="mevsim" class="block text-sm font-medium text-gray-700 mb-1.5">Mevsim *</label>
                        <select id="mevsim" name="mevsim" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none bg-white pr-10" 
                                required>
                            <option value="">Seçiniz...</option>
                            <option value="Yaz">Yaz</option>
                            <option value="Kış">Kış</option>
                            <option value="4 Mevsim">4 Mevsim</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="dis_durumu" class="block text-sm font-medium text-gray-700 mb-1.5">Diş Durumu *</label>
                        <select id="dis_durumu" name="dis_durumu" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none bg-white pr-10" 
                                required>
                            <option value="">Seçiniz...</option>
                            <option value="Sıfır">Sıfır</option>
                            <option value="İyi">İyi</option>
                            <option value="Orta">Orta</option>
                            <option value="Kötü">Kötü</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="brand" class="block text-sm font-medium text-gray-700 mb-1.5">Marka *</label>
                        <div class="flex items-center gap-2">
                            <select id="brand" name="brand" 
                                    class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none bg-white pr-10" 
                                    required>
                                <option value="">Seçiniz...</option>
                                {% if brands %}
                                    {% for brand in brands %}
                                    <option value="{{ brand }}">{{ brand }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <button type="button" onclick="showAddBrandModal()" 
                                    class="px-3 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors shadow-sm flex-shrink-0"
                                    title="Yeni marka ekle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                            <button type="button" onclick="confirmDeleteBrand()" 
                                    class="px-3 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors shadow-sm flex-shrink-0"
                                    title="Seçili markayı sil">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="brand_note" class="block text-sm font-medium text-gray-700 mb-1.5">Marka Notu / Ek Bilgi</label>
                    <textarea id="brand_note" name="brand_note" 
                              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                              rows="3"></textarea>
                </div>
                
                <div>
                    <label for="not" class="block text-sm font-medium text-gray-700 mb-1.5">Genel Not</label>
                    <textarea id="not" name="not" 
                              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                              rows="3" 
                              placeholder="Genel notlar..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Depot Shelf Selection -->
        <div id="step3" class="mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-6">3. Depo Rafını Seç ve Kaydet</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="raf_id" class="block text-sm font-medium text-gray-700 mb-1.5">Raf Kodu *</label>
                        <select id="raf_id" name="raf_id" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none bg-white pr-10" 
                                required>
                            <option value="">Seçiniz...</option>
                            {% if racks %}
                                {% for rack in racks %}
                                <option value="{{ rack.id }}" 
                                        data-status="{{ rack.durum }}"
                                        data-code="{{ rack.kod }}">
                                    {{ rack.kod }}
                                </option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>Henüz raf oluşturulmamış. Lütfen önce raf ekleyin.</option>
                            {% endif %}
                        </select>
                        <p id="rackStatus" class="text-sm text-gray-600 mt-2" style="display: none;"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Submit Button -->
        <div class="flex justify-end mb-6">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-8 py-2.5 rounded-lg transition-colors shadow-sm">
                Depoya Kaydet
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dynamic tire fields management
let tireCount = 0;
const maxTires = 6;
const tireSizes = {{ tire_sizes | tojson if tire_sizes else '[]' }};
const manualTireSizes = new Set();  // Tracks sizes added manually in this session
const manualBrands = new Set();      // Tracks brands added manually in this session

function addTireField() {
    if (tireCount >= maxTires) {
        showErrorModal(`Maksimum ${maxTires} lastik eklenebilir!`);
        return;
    }
    
    tireCount++;
    const container = document.getElementById('tiresContainer');
    const tireDiv = document.createElement('div');
    tireDiv.className = 'tire-field-item grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg relative';
    tireDiv.setAttribute('data-tire-index', tireCount);
    
    tireDiv.innerHTML = `
        <div>
            <label for="tire${tireCount}_size" class="block text-sm font-medium text-gray-700 mb-1.5">${tireCount}. Lastik Ebatı</label>
            <div class="flex items-center gap-2">
                <select id="tire${tireCount}_size" name="tire${tireCount}_size" 
                        class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none bg-white pr-10">
                    <option value="">Seçiniz...</option>
                    ${tireSizes.map(size => {
                        const manualAttr = manualTireSizes.has(size) ? ' data-manual="true"' : '';
                        return `<option value="${size}"${manualAttr}>${size}</option>`;
                    }).join('')}
                </select>
                <button type="button" onclick="showAddTireSizeModal()" 
                        class="px-3 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors shadow-sm flex-shrink-0"
                        title="Yeni ebat ekle">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
                <button type="button" onclick="confirmDeleteTireSize('tire${tireCount}_size')" 
                        class="px-3 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors shadow-sm flex-shrink-0"
                        title="Seçili ebatı sil">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div>
            <label for="tire${tireCount}_production_date" class="block text-sm font-medium text-gray-700 mb-1.5">${tireCount}. Lastik Üretim Yılı</label>
            <div class="flex items-end gap-2">
                <input type="text" id="tire${tireCount}_production_date" name="tire${tireCount}_production_date" 
                       class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                       maxlength="4" pattern="[0-9]{4}">
                ${tireCount > 1 ? `<button type="button" onclick="removeTireField(${tireCount})" class="px-3 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors" title="Bu lastiği kaldır">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>` : ''}
            </div>
        </div>
    `;
    
    container.appendChild(tireDiv);
    updateAddButtonState();
    updateTireLabels();
}

function removeTireField(tireIndex) {
    const tireItem = document.querySelector(`[data-tire-index="${tireIndex}"]`);
    if (tireItem) {
        tireItem.remove();
        tireCount--;
        updateAddButtonState();
        updateTireLabels();
    }
}

function updateAddButtonState() {
    const addBtn = document.getElementById('addTireBtn');
    if (tireCount >= maxTires) {
        addBtn.disabled = true;
        addBtn.classList.add('opacity-50', 'cursor-not-allowed');
        addBtn.classList.remove('hover:bg-blue-700');
    } else {
        addBtn.disabled = false;
        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addBtn.classList.add('hover:bg-blue-700');
    }
}

function updateTireLabels() {
    const tireItems = document.querySelectorAll('.tire-field-item');
    tireItems.forEach((item, index) => {
        const tireNum = index + 1;
        item.setAttribute('data-tire-index', tireNum);
        const sizeLabel = item.querySelector('label[for^="tire"]');
        const dateLabel = item.querySelector('label[for*="production_date"]');
        const sizeSelectContainer = item.querySelector('div.flex.items-center.gap-2');
        const sizeSelect = item.querySelector('select[id^="tire"]');
        const dateInput = item.querySelector('input[id*="production_date"]');
        const removeBtn = item.querySelector('button[onclick*="removeTireField"]');
        
        if (sizeLabel) {
            sizeLabel.textContent = `${tireNum}. Lastik Ebatı`;
            sizeLabel.setAttribute('for', `tire${tireNum}_size`);
        }
        if (dateLabel) {
            dateLabel.textContent = `${tireNum}. Lastik Üretim Yılı`;
            dateLabel.setAttribute('for', `tire${tireNum}_production_date`);
        }
        if (sizeSelect) {
            sizeSelect.id = `tire${tireNum}_size`;
            sizeSelect.name = `tire${tireNum}_size`;
        }
        if (dateInput) {
            dateInput.id = `tire${tireNum}_production_date`;
            dateInput.name = `tire${tireNum}_production_date`;
        }
        if (removeBtn && tireNum > 1) {
            removeBtn.setAttribute('onclick', `removeTireField(${tireNum})`);
        } else if (removeBtn && tireNum === 1) {
            removeBtn.remove();
        }
    });
}

function showErrorModal(message) {
    const errorModal = document.createElement('div');
    errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    errorModal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center space-x-4 mb-4">
                <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                    <p class="text-sm text-gray-600 mt-1">${message}</p>
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                    Kapat
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(errorModal);
}

function showSuccessModal(message) {
    const successModal = document.createElement('div');
    successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    successModal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center space-x-4 mb-4">
                <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">Bilgi</h3>
                    <p class="text-sm text-gray-600 mt-1">${message}</p>
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                    Tamam
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(successModal);
    setTimeout(() => successModal.remove(), 2000);
}

function showConfirmModal(message) {
    return new Promise((resolve) => {
        const confirmModal = document.createElement('div');
        confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        confirmModal.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center space-x-4 mb-4">
                    <div class="flex-shrink-0 w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900">Onay</h3>
                        <p class="text-sm text-gray-600 mt-1">${message}</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                        Vazgeç
                    </button>
                    <button class="bg-red-600 hover:bg-red-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                        Sil
                    </button>
                </div>
            </div>
        `;

        const buttons = confirmModal.querySelectorAll('button');
        const cancelBtn = buttons[0];
        const confirmBtn = buttons[1];

        cancelBtn.addEventListener('click', () => {
            confirmModal.remove();
            resolve(false);
        });

        confirmBtn.addEventListener('click', () => {
            confirmModal.remove();
            resolve(true);
        });

        document.body.appendChild(confirmModal);
    });
}

async function confirmDeleteTireSize(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;

    if (!select.value) {
        showErrorModal('Silmek için önce ebat seçin!');
        return;
    }

    const selectedValue = select.value;
    const selectedOption = select.options[select.selectedIndex];
    const isManual = (selectedOption && selectedOption.dataset && selectedOption.dataset.manual === 'true') || manualTireSizes.has(selectedValue);

    if (!isManual) {
        showErrorModal('Sadece manuel eklenen ebatlar silinebilir.');
        return;
    }

    const confirmed = await showConfirmModal(`'${selectedValue}' ebatını silmek istediğinize emin misiniz?`);
    if (!confirmed) return;

    try {
        const response = await fetch(`/api/tire-sizes/?ebat=${encodeURIComponent(selectedValue)}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            let errorMessage = 'Ebat silinemedi';
            try {
                const errorData = await response.json();
                errorMessage = errorData.detail || errorMessage;
            } catch (_) {
                // ignore json parse errors
            }
            showErrorModal(errorMessage);
            return;
        }

        // Remove the option from all tire size dropdowns and clear selection where needed
        document.querySelectorAll('select[id*="_size"]').forEach((dropdown) => {
            const optionToRemove = Array.from(dropdown.options).find(opt => opt.value === selectedValue);
            if (optionToRemove) {
                optionToRemove.remove();
            }
            if (dropdown.value === selectedValue) {
                dropdown.value = '';
            }
        });

        // Remove from local caches
        const sizeIndex = tireSizes.indexOf(selectedValue);
        if (sizeIndex !== -1) {
            tireSizes.splice(sizeIndex, 1);
        }
        manualTireSizes.delete(selectedValue);

        showSuccessModal('Ebat silindi');
    } catch (error) {
        console.error('Error deleting tire size:', error);
        showErrorModal('Bir hata oluştu: ' + error.message);
    }
}

async function confirmDeleteBrand() {
    const brandSelect = document.getElementById('brand');
    if (!brandSelect) return;

    const selectedValue = brandSelect.value;
    if (!selectedValue) {
        showErrorModal('Silmek için bir marka seçin!');
        return;
    }

    const selectedOption = brandSelect.options[brandSelect.selectedIndex];
    const isManual = (selectedOption && selectedOption.dataset && selectedOption.dataset.manual === 'true') || manualBrands.has(selectedValue);

    if (!isManual) {
        showErrorModal('Sadece manuel eklenen markalar silinebilir.');
        return;
    }

    const confirmed = await showConfirmModal(`'${selectedValue}' markasını silmek istediğinize emin misiniz?`);
    if (!confirmed) return;

    try {
        const response = await fetch(`/api/brands/${encodeURIComponent(selectedValue)}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            let errorMessage = 'Marka silinemedi';
            try {
                const errorData = await response.json();
                errorMessage = errorData.detail || errorMessage;
            } catch (_) {
                // ignore json parse errors
            }
            showErrorModal(errorMessage);
            return;
        }

        // Remove the option from dropdown
        const optionToRemove = Array.from(brandSelect.options).find(opt => opt.value === selectedValue);
        if (optionToRemove) {
            optionToRemove.remove();
        }
        brandSelect.value = '';
        manualBrands.delete(selectedValue);

        showSuccessModal('Marka silindi');
    } catch (error) {
        console.error('Error deleting brand:', error);
        showErrorModal('Bir hata oluştu: ' + error.message);
    }
}

// Initialize: Add first tire field on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have existing tire data to pre-fill
    const existingTireData = {{ existing_tire_data | tojson if existing_tire_data else 'null' }};
    
    if (existingTireData) {
        // Pre-fill customer information
        document.getElementById('customer_name').value = existingTireData.customer_name || '';
        document.getElementById('customer_plate').value = existingTireData.customer_plate || '';
        document.getElementById('customer_phone').value = existingTireData.customer_phone || '';
        
        // Pre-fill tire information
        if (existingTireData.brand) {
            document.getElementById('brand').value = existingTireData.brand;
        }
        if (existingTireData.mevsim) {
            document.getElementById('mevsim').value = existingTireData.mevsim;
        }
        if (existingTireData.dis_durumu) {
            document.getElementById('dis_durumu').value = existingTireData.dis_durumu;
        }
        if (existingTireData.raf_id) {
            document.getElementById('raf_id').value = existingTireData.raf_id;
        }
        if (existingTireData.brand_note) {
            document.getElementById('brand_note').value = existingTireData.brand_note;
        }
        if (existingTireData.general_note) {
            document.getElementById('not').value = existingTireData.general_note;
        }
        
        // Pre-fill tire sizes
        if (existingTireData.tire_sizes && existingTireData.tire_sizes.length > 0) {
            // Clear container first
            document.getElementById('tiresContainer').innerHTML = '';
            tireCount = 0;
            
            // Add tire fields for each existing tire
            existingTireData.tire_sizes.forEach((size, index) => {
                addTireField();
                const tireItem = document.querySelector(`[data-tire-index="${tireCount}"]`);
                if (tireItem) {
                    const sizeSelect = tireItem.querySelector('select[id$="_size"]');
                    const yearInput = tireItem.querySelector('input[id$="_production_date"]');
                    if (sizeSelect) {
                        sizeSelect.value = size;
                    }
                    if (yearInput && existingTireData.tire_production_dates && existingTireData.tire_production_dates[index]) {
                        yearInput.value = existingTireData.tire_production_dates[index];
                    }
                }
            });
        } else {
            // Add initial tire field if no existing data
            addTireField();
        }
    } else {
        // Add initial tire field
        addTireField();
    }
    
    // Raf seçildiğinde durumunu göster
    const rafSelect = document.getElementById('raf_id');
    if (rafSelect) {
        rafSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const status = selectedOption.getAttribute('data-status');
            const statusText = document.getElementById('rackStatus');
            
            if (status && statusText) {
                statusText.textContent = `Bu raf şu anda: ${status}`;
                statusText.style.display = 'block';
            } else if (statusText) {
                statusText.style.display = 'none';
            }
        });
    }
    
    // Form submit handler
    const tireForm = document.getElementById('tireForm');
    if (tireForm) {
        tireForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate all fields
            const customerName = document.getElementById('customer_name').value.trim();
            const customerPlate = document.getElementById('customer_plate').value.trim();
            const customerPhone = document.getElementById('customer_phone').value.trim();
            const mevsim = document.getElementById('mevsim').value;
            const dis_durumu = document.getElementById('dis_durumu').value;
            const brand = document.getElementById('brand').value;
            const rafId = document.getElementById('raf_id').value;
            
            // Collect tire data dynamically from all tire fields
            const tires = [];
            const tireItems = document.querySelectorAll('.tire-field-item');
            tireItems.forEach((item) => {
                const sizeSelect = item.querySelector('select[id^="tire"]');
                const yearInput = item.querySelector('input[id*="production_date"]');
                if (sizeSelect && sizeSelect.value) {
                    let productionYear = null;
                    if (yearInput && yearInput.value && yearInput.value.trim()) {
                        const year = yearInput.value.trim();
                        // Validate year (4 digits, reasonable range)
                        if (/^\d{4}$/.test(year) && parseInt(year) >= 1900 && parseInt(year) <= new Date().getFullYear() + 1) {
                            productionYear = year;
                        }
                    }
                    tires.push({
                        size: sizeSelect.value,
                        production_date: productionYear
                    });
                }
            });
            
            // Validation
            if (!customerName || !customerPlate || !customerPhone) {
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                <p class="text-sm text-gray-600 mt-1">Lütfen tüm müşteri bilgilerini doldurun!</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                Kapat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
                return;
            }
            
            if (tires.length === 0) {
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                <p class="text-sm text-gray-600 mt-1">En az bir lastik ebatı seçmelisiniz!</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                Kapat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
                return;
            }
            
            if (!mevsim || !dis_durumu || !brand) {
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                <p class="text-sm text-gray-600 mt-1">Lütfen tüm zorunlu lastik bilgilerini doldurun!</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                Kapat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
                return;
            }
            
            if (!rafId) {
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                <p class="text-sm text-gray-600 mt-1">Lütfen bir raf seçin!</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                Kapat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
                return;
            }
            
            // Önce müşteriyi oluştur veya bul
            let customerId;
            try {
                // Müşteriyi ara
                const searchResponse = await fetch(`/api/customers/?skip=0&limit=100`);
                const customers = await searchResponse.json();
                
                const existingCustomer = customers.find(c => 
                    c.plaka === customerPlate && 
                    c.telefon === customerPhone
                );
                
                if (existingCustomer) {
                    customerId = existingCustomer.id;
                } else {
                    // Yeni müşteri oluştur
                    const createResponse = await fetch('/api/customers/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ad_soyad: customerName,
                            telefon: customerPhone,
                            plaka: customerPlate
                        })
                    });
                    
                    if (createResponse.ok) {
                        const newCustomer = await createResponse.json();
                        customerId = newCustomer.id;
                    } else {
                        const error = await createResponse.json();
                        const errorMessage = error.detail || 'Müşteri oluşturulamadı';
                        
                        const errorModal = document.createElement('div');
                        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        errorModal.innerHTML = `
                            <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                        <p class="text-sm text-gray-600 mt-1">${errorMessage}</p>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                        Kapat
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(errorModal);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error with customer:', error);
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                <p class="text-sm text-gray-600 mt-1">Bir hata oluştu: ${error.message}</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                Kapat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
                return;
            }
            
            // Lastik bilgilerini hazırla
            const brandNote = document.getElementById('brand_note').value;
            const generalNote = document.getElementById('not').value;
            const combinedNote = [brandNote, generalNote].filter(n => n).join('\n\n') || null;
            
            // Build tire data with multiple tires
            const tireData = {
                musteri_id: parseInt(customerId),
                brand: brand,
                ebat: tires[0]?.size || '',  // Keep for backward compatibility
                mevsim: mevsim,
                dis_durumu: dis_durumu,
                not: combinedNote,
                raf_id: parseInt(rafId),
                durum: "Depoda"
            };
            
            // Initialize all 6 tire fields as null
            for (let i = 1; i <= 6; i++) {
                tireData[`tire${i}_size`] = null;
                tireData[`tire${i}_production_date`] = null;
            }
            
            // Fill in tire data from collected tires
            tires.forEach((tire, index) => {
                const tireNum = index + 1;
                if (tireNum <= 6) {
                    tireData[`tire${tireNum}_size`] = tire.size;
                    // Production date is now just a year string (e.g., "2024")
                    tireData[`tire${tireNum}_production_date`] = tire.production_date || null;
                }
            });
            
            // Debug: Log the data being sent
            console.log('Sending tire data:', tireData);
            
            // Check if this is a tire change operation
            const existingTireData = {{ existing_tire_data | tojson if existing_tire_data else 'null' }};
            const isChangeOperation = existingTireData && existingTireData.tire_id;
            
            try {
                let response;
                if (isChangeOperation) {
                    // Use change endpoint
                    response = await fetch(`/api/tires/${existingTireData.tire_id}/change`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(tireData)
                    });
                } else {
                    // Use create endpoint
                    response = await fetch('/api/tires/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(tireData)
                    });
                }
                
                if (response.ok) {
                    // Show success message
                    const successModal = document.createElement('div');
                    successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    successModal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">Başarılı</h3>
                                    <p class="text-sm text-gray-600 mt-1">Lastik başarıyla depoya kaydedildi!</p>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button onclick="this.closest('.fixed').remove(); window.location.href = '/lastik-ara';" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                                    Tamam
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(successModal);
                    setTimeout(() => {
                        successModal.remove();
                        window.location.href = '/lastik-ara';
                    }, 1500);
                } else {
                    // Try to parse error as JSON, if fails show text
                    let errorMessage = 'Lastik kaydedilemedi';
                    try {
                        const errorData = await response.json();
                        if (errorData && typeof errorData === 'object') {
                            errorMessage = errorData.detail || errorData.message || JSON.stringify(errorData);
                        } else if (typeof errorData === 'string') {
                            errorMessage = errorData;
                        }
                    } catch (e) {
                        // If JSON parsing fails, try to get text
                        try {
                            const errorText = await response.text();
                            errorMessage = errorText || 'Lastik kaydedilemedi';
                        } catch (textError) {
                            errorMessage = `Sunucu hatası: ${response.status} ${response.statusText}`;
                        }
                    }
                    
                    // Show error message
                    const errorModal = document.createElement('div');
                    errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    errorModal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                    <p class="text-sm text-gray-600 mt-1">${errorMessage}</p>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                    Kapat
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(errorModal);
                }
            } catch (error) {
                console.error('Error creating tire:', error);
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">Hata</h3>
                                <p class="text-sm text-gray-600 mt-1">Bir hata oluştu: ${error.message}</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                                Kapat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
            }
        });
    }
});

// Add Brand Modal Functions
function showAddBrandModal() {
    document.getElementById('addBrandModal').classList.remove('hidden');
    document.getElementById('newBrandName').value = '';
    document.getElementById('newBrandName').focus();
}

function hideAddBrandModal() {
    document.getElementById('addBrandModal').classList.add('hidden');
    document.getElementById('newBrandName').value = '';
}

async function saveNewBrand() {
    const brandName = document.getElementById('newBrandName').value.trim();
    
    if (!brandName) {
        showErrorModal('Lütfen marka adını girin!');
        return;
    }
    
    try {
        const response = await fetch('/api/brands/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ marka_adi: brandName })
        });
        
        if (response.ok) {
            const newBrand = await response.json();
            
            // Add to brand dropdown
            const brandSelect = document.getElementById('brand');
            const newOption = document.createElement('option');
            newOption.value = newBrand.marka_adi;
            newOption.textContent = newBrand.marka_adi;
            newOption.dataset.manual = "true";
            newOption.selected = true;
            brandSelect.appendChild(newOption);
            manualBrands.add(newBrand.marka_adi);
            
            hideAddBrandModal();
            
            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            successModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900">Başarılı</h3>
                            <p class="text-sm text-gray-600 mt-1">Marka başarıyla eklendi!</p>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                            Tamam
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);
            setTimeout(() => successModal.remove(), 2000);
        } else {
            const errorData = await response.json();
            showErrorModal(errorData.detail || 'Marka eklenemedi');
        }
    } catch (error) {
        console.error('Error adding brand:', error);
        showErrorModal('Bir hata oluştu: ' + error.message);
    }
}

// Add Tire Size Modal Functions
function showAddTireSizeModal() {
    document.getElementById('addTireSizeModal').classList.remove('hidden');
    document.getElementById('newTireSize').value = '';
    document.getElementById('newTireSize').focus();
}

function hideAddTireSizeModal() {
    document.getElementById('addTireSizeModal').classList.add('hidden');
    document.getElementById('newTireSize').value = '';
}

async function saveNewTireSize() {
    const tireSize = document.getElementById('newTireSize').value.trim();
    
    if (!tireSize) {
        showErrorModal('Lütfen lastik ebatını girin!');
        return;
    }
    
    try {
        const response = await fetch('/api/tire-sizes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ebat: tireSize })
        });
        
        if (response.ok) {
            const newSize = await response.json();
            
            // Add to all tire size dropdowns
            const tireSizeSelects = document.querySelectorAll('select[id*="_size"]');
            tireSizeSelects.forEach(select => {
                // Avoid duplicate options
                const alreadyExists = Array.from(select.options).some(opt => opt.value === newSize.ebat);
                if (!alreadyExists) {
                    const newOption = document.createElement('option');
                    newOption.value = newSize.ebat;
                    newOption.textContent = newSize.ebat;
                    newOption.dataset.manual = "true";
                    select.appendChild(newOption);
                }
            });
            
            // Update tireSizes array for dynamic tire fields
            if (!tireSizes.includes(newSize.ebat)) {
                tireSizes.push(newSize.ebat);
            }
            manualTireSizes.add(newSize.ebat);
            
            hideAddTireSizeModal();
            
            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            successModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900">Başarılı</h3>
                            <p class="text-sm text-gray-600 mt-1">Ebat başarıyla eklendi!</p>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                            Tamam
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);
            setTimeout(() => successModal.remove(), 2000);
        } else {
            const errorData = await response.json();
            showErrorModal(errorData.detail || 'Ebat eklenemedi');
        }
    } catch (error) {
        console.error('Error adding tire size:', error);
        showErrorModal('Bir hata oluştu: ' + error.message);
    }
}
</script>

<!-- Add Brand Modal -->
<div id="addBrandModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Yeni Marka Ekle</h3>
        <div class="space-y-4">
            <div>
                <label for="newBrandName" class="block text-sm font-medium text-gray-700 mb-1.5">Marka Adı *</label>
                <input type="text" id="newBrandName" 
                       class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                       placeholder="Marka adını girin">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="hideAddBrandModal()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                    İptal
                </button>
                <button type="button" onclick="saveNewBrand()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                    Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Tire Size Modal -->
<div id="addTireSizeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Yeni Ebat Ekle</h3>
        <div class="space-y-4">
            <div>
                <label for="newTireSize" class="block text-sm font-medium text-gray-700 mb-1.5">Lastik Ebatı *</label>
                <input type="text" id="newTireSize" 
                       class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                       placeholder="Örn: 225/50 R17">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="hideAddTireSizeModal()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                    İptal
                </button>
                <button type="button" onclick="saveNewTireSize()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                    Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
