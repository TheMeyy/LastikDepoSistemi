{% extends "base.html" %}

{% block title %}Lastik Etiketleri - Lastik Depo Sistemi{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<script>
    // Define handleLabelButtonClick function early, before page loads
    // Safe wrapper function to handle button clicks
    window.handleLabelButtonClickSafe = function (button) {
        if (typeof handleLabelButtonClick === 'function') {
            let tireId = parseInt(button.getAttribute('data-tire-id')) || 0;
            console.log('handleLabelButtonClickSafe - tireId:', tireId);

            // Get tire sizes from global object
            let tireSizes = [];
            if (window.tireSizesData && window.tireSizesData[tireId]) {
                tireSizes = window.tireSizesData[tireId];
                if (Array.isArray(tireSizes)) {
                    tireSizes = tireSizes.filter(size => size && String(size).trim() !== '');
                    console.log('handleLabelButtonClickSafe - Got tireSizes from global object:', tireSizes, 'length:', tireSizes.length);
                } else {
                    console.warn('handleLabelButtonClickSafe - tireSizesData[' + tireId + '] is not an array:', tireSizes);
                    tireSizes = [];
                }
            } else {
                console.warn('handleLabelButtonClickSafe - No tire sizes found for tire ID:', tireId, 'Available IDs:', Object.keys(window.tireSizesData || {}));
            }

            console.log('handleLabelButtonClickSafe - Final tireSizes:', tireSizes, 'length:', tireSizes.length);
            handleLabelButtonClick(button, tireSizes);
        } else {
            alert('Etiket sistemi yükleniyor... Lütfen bekleyin.');
        }
    };

    window.handleLabelButtonClick = function (button, tireSizesFromTemplate) {
        // alert('handleLabelButtonClick çağrıldı!'); // Test için - disabled
        try {
            console.log('handleLabelButtonClick called', button);

            if (!button) {
                alert('Button bulunamadı!');
                return;
            }

            const tireId = parseInt(button.getAttribute('data-tire-id')) || 0;
            const seriNo = button.getAttribute('data-seri-no') || '';
            const customerName = button.getAttribute('data-customer-name') || '';
            const customerPhone = button.getAttribute('data-customer-phone') || '';
            const customerPlate = button.getAttribute('data-customer-plate') || '';
            const brand = button.getAttribute('data-brand') || '';
            const mevsim = button.getAttribute('data-mevsim') || '';
            const rackCode = button.getAttribute('data-rack-code') || '';
            const disDurumu = button.getAttribute('data-dis-durumu') || '';
            const girisTarihi = button.getAttribute('data-giris-tarihi') || '';

            // Use tireSizes from template parameter if available, otherwise parse from attribute/global
            let tireSizes = [];
            let tireBrands = [];
            let tireMevsims = [];
            if (tireSizesFromTemplate && Array.isArray(tireSizesFromTemplate)) {
                tireSizes = tireSizesFromTemplate; // Removed filter
            } else {
                const tireSizesJson = button.getAttribute('data-tire-sizes') || '[]';
                try {
                    const parsed = JSON.parse(tireSizesJson);
                    if (Array.isArray(parsed)) {
                        tireSizes = parsed; // Removed filter
                    }
                } catch (e) {
                    console.error('Error parsing tire sizes from attribute:', e);
                }
            }
            // Try globals as fallback
            const tireIdFromGlobals = tireId || parseInt(button.getAttribute('data-tire-id')) || 0;
            if ((!tireSizes || tireSizes.length === 0) && window.tireSizesData && window.tireSizesData[tireIdFromGlobals]) {
                tireSizes = window.tireSizesData[tireIdFromGlobals] || []; // Removed filter
            }
            // Parse brand/mevsim arrays from attributes or globals
            try {
                const brandsJson = button.getAttribute('data-tire-brands') || '[]';
                const parsedBrands = JSON.parse(brandsJson);
                if (Array.isArray(parsedBrands)) tireBrands = parsedBrands;
            } catch (e) { console.warn('Brand parse failed'); }
            try {
                const mevsimsJson = button.getAttribute('data-tire-mevsims') || '[]';
                const parsedMevsims = JSON.parse(mevsimsJson);
                if (Array.isArray(parsedMevsims)) tireMevsims = parsedMevsims;
            } catch (e) { console.warn('Mevsim parse failed'); }
            if ((!tireBrands || tireBrands.length === 0) && window.tireBrandsData && window.tireBrandsData[tireIdFromGlobals]) {
                tireBrands = window.tireBrandsData[tireIdFromGlobals] || [];
            }
            if ((!tireMevsims || tireMevsims.length === 0) && window.tireMevsimsData && window.tireMevsimsData[tireIdFromGlobals]) {
                tireMevsims = window.tireMevsimsData[tireIdFromGlobals] || [];
            }

            console.log('Final tireSizes array:', tireSizes, 'length:', tireSizes.length);
            console.log('Seri No:', seriNo);

            // Call the real showLabelPreview function
            if (typeof window._realShowLabelPreview === 'function') {
                window._realShowLabelPreview(tireId, customerName, customerPhone, customerPlate, tireSizes, brand, mevsim, rackCode, disDurumu, girisTarihi, seriNo, tireBrands, tireMevsims);
            } else {
                // Fallback to window.showLabelPreview (stub)
                window.showLabelPreview(tireId, customerName, customerPhone, customerPlate, tireSizes, brand, mevsim, rackCode, disDurumu, girisTarihi, seriNo, tireBrands, tireMevsims);
            }
        } catch (error) {
            console.error('Error in handleLabelButtonClick:', error);
            alert('Etiket oluşturulurken bir hata oluştu: ' + error.message);
        }
    };

    // Define a stub showLabelPreview that will wait for the real one
    window.showLabelPreview = function (tireId, customerName, customerPhone, customerPlate, tireSizes, brand, mevsim, rackCode, disDurumu, girisTarihi, seriNo) {
        // This is a placeholder - the real function will be defined in scripts block
        console.log('showLabelPreview stub called - waiting for real function');

        // Store the parameters and try again after a delay
        const args = Array.from(arguments);
        let attempts = 0;
        const maxAttempts = 30; // Wait up to 3 seconds

        function tryCallRealFunction() {
            attempts++;
            if (typeof window._realShowLabelPreview === 'function') {
                window._realShowLabelPreview.apply(null, args);
            } else if (attempts < maxAttempts) {
                setTimeout(tryCallRealFunction, 100);
            } else {
                alert('Etiket önizleme sistemi yükleniyor... Lütfen birkaç saniye bekleyip tekrar deneyin.');
                console.error('_realShowLabelPreview function not found after', attempts, 'attempts');
            }
        }

        tryCallRealFunction();
    };

    console.log('handleLabelButtonClick function defined in extra_head');
    console.log('showLabelPreview stub function defined:', typeof window.showLabelPreview);
</script>
<style>
    :root {
        --brand-orange: #F26B1D;
        --text-gray: #333;
        --text-light-gray: #666;
        --bg-light-gray: #FAFAFA;
        --bg-depo-gray: #F9F9F9;
    }

    .label {
        font-family: 'Poppins', sans-serif;
    }

    /* =========================
   YENİ DEPO ETİKETİ TASARIMI
   ========================= */

    .depo-label {
        width: 95mm;
        height: 63mm;
        padding: 4mm;
        box-sizing: border-box;
        border: 1.5px solid #F26B1D;
        border-radius: 8px;
        background: #F9F9F9;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
    }

    /* ÜST SATIR: RAF | PLAKA | SERİ */
    .depo-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 800;
        font-size: 18pt;
        color: #111;
        line-height: 1;
    }

    /* ALT ALAN */
    .depo-body {
        display: flex;
        flex-direction: column;
        gap: 3mm;
    }

    /* MÜŞTERİ ADI */
    .depo-customer {
        font-size: 11.5pt;
        font-weight: 700;
        color: #111;
    }

    /* EBAT | MARKA TABLOSU */
    .depo-table {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.8mm 4mm;
        font-size: 10.5pt;
        font-weight: 700;
        color: #111;
    }

    /* GİRİŞ TARİHİ */
    .depo-date {
        font-size: 9.5pt;
        font-weight: 600;
        color: #333;
    }


    /* Müşteri Etiketi Stili */
    .musteri-label {
        width: 95mm;
        height: 80mm;
        background: white;
        border: 1.5px solid var(--brand-orange);
        border-radius: 8px;
        padding: 4mm;
        box-sizing: border-box;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        overflow: visible;
    }

    .label-header {
        text-align: center;
        margin-bottom: 2mm;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 2mm;
        position: relative;
    }

    .label-seri-no {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 8pt;
        font-weight: 700;
        color: #333;
        font-family: 'Poppins', sans-serif;
        z-index: 10;
        white-space: nowrap;
    }

    .label-logo {
        max-width: 50px;
        max-height: 35px;
        margin-bottom: 0.5mm;
        object-fit: contain;
    }

    .label-title {
        text-align: center;
        margin-bottom: 2mm;
        flex-shrink: 0;
        margin-top: 0mm;
    }

    .label-title-main {
        font-size: 11pt;
        font-weight: 700;
        color: var(--brand-orange);
        margin-bottom: 0.3mm;
        margin-top: 0mm;
        letter-spacing: 0.5px;
        text-align: center;
    }

    .label-title-sub {
        font-size: 7.5pt;
        font-weight: 500;
        color: var(--text-gray);
        text-align: center;
        margin-bottom: 0mm;
    }

    .label-content {
        font-size: 6pt;
        color: var(--text-gray);
        line-height: 1.15;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        min-height: 0;
        overflow: visible;
        padding-bottom: 1mm;
        /* Telefon numaraları için alt boşluk */
    }

    .label-content div {
        margin-bottom: 0.7mm;
        flex-shrink: 0;
    }

    .label-field {
        font-weight: 600;
        display: inline-block;
        width: 22mm;
        color: var(--text-gray);
        vertical-align: top;
    }

    .label-tire-sizes-grid {
        display: inline-grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5mm 2.5mm;
        margin-left: 0mm;
        vertical-align: top;
        font-size: 6pt;
    }

    .label-value {
        font-weight: 400;
        color: var(--text-gray);
    }



    /* Print Styles */
    @media print {
        body * {
            visibility: hidden;
        }

        #printArea,
        #printArea * {
            visibility: visible;
        }

        #printArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }

        .no-print {
            display: none !important;
        }

        .depo-label,
        .musteri-label {
            page-break-inside: avoid;
        }

        /* Yazdır ekranında telefon numaralarını çerçeve içine almak için */
        .depo-label .label-content,
        .musteri-label .label-content,
        .isyeri-label .label-content {
            padding-bottom: 4mm !important;
            /* Yazdır için daha fazla alt boşluk */
        }

        /* Depo etiketlerinde alt boşluğu azalt */
        .depo-label .label-content {
            padding-bottom: 1.2mm !important;
        }

        /* Telefon numaraları için özel stil - çerçeve içinde kalması için */
        .label-phone-numbers {
            margin-top: 0mm !important;
            /* Daha yukarı almak için margin'i azalt */
            padding-top: 0mm !important;
            /* Daha yukarı almak için padding'i azalt */
            padding-bottom: 1.5mm !important;
            /* Alt boşluk - çerçeve içinde kalması için */
            font-size: 5.5pt !important;
            /* Yazdır için font boyutunu küçült (önizleme ve PDF'de 6.5pt) */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Page Title -->
    <div class="flex items-center justify-between mb-2">
        <h1 class="text-3xl font-bold text-gray-900">Lastik Etiketleri</h1>
    </div>
    <p class="text-gray-600 mb-8">Son eklenen lastik kayıtları için etiket oluşturun.</p>

    <!-- Filter Form -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">Filtrele</h2>
        <form method="get" action="/lastik-etiketleri" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-1.5">Müşteri
                        Adı</label>
                    <input type="text" id="customer_name" name="customer_name" value="{{ query_params.customer_name }}"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                        placeholder="">
                </div>

                <div>
                    <label for="plate" class="block text-sm font-medium text-gray-700 mb-1.5">Plaka</label>
                    <input type="text" id="plate" name="plate" value="{{ query_params.plate }}"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                        placeholder="">
                </div>

                <div class="relative">
                    <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1.5">Başlangıç
                        Tarihi</label>
                    <div class="relative">
                        <input type="date" id="date_from" name="date_from" value="{{ query_params.date_from }}"
                            class="w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        <svg class="absolute left-3 top-9 w-5 h-5 text-gray-400 pointer-events-none" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                </div>

                <div class="relative">
                    <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1.5">Bitiş Tarihi</label>
                    <div class="relative">
                        <input type="date" id="date_to" name="date_to" value="{{ query_params.date_to }}"
                            class="w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        <svg class="absolute left-3 top-9 w-5 h-5 text-gray-400 pointer-events-none" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="flex justify-end items-center space-x-3 pt-2">
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm hover:shadow-md">
                    Filtrele
                </button>
                <a href="/lastik-etiketleri"
                    class="bg-white border border-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                    Filtreleri Temizle
                </a>
            </div>
        </form>
    </div>
    <!-- Tires List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Müşteri Adı</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plaka
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giriş
                            Tarihi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İşlem
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if tires %}
                    <script>
                        // Global object to store tire sizes by tire ID
                        window.tireSizesData = window.tireSizesData || {};
                        window.tireBrandsData = window.tireBrandsData || {};
                        window.tireMevsimsData = window.tireMevsimsData || {};
                        {% for tire in tires %}
                        window.tireSizesData[{{ tire.id }}] = {{ tire.tire_sizes | tojson | safe }};
                        window.tireBrandsData[{{ tire.id }}] = {{ tire.tire_brands | tojson | safe }};
                        window.tireMevsimsData[{{ tire.id }}] = {{ tire.tire_mevsims | tojson | safe }};
                        {% endfor %}
                    </script>
                    {% for tire in tires %}
                    {% set tire_sizes_list = tire.tire_sizes if tire.tire_sizes else [] %}
                    {% set tire_brands_list = tire.tire_brands if tire.tire_brands else [] %}
                    {% set tire_mevsims_list = tire.tire_mevsims if tire.tire_mevsims else [] %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ tire.customer_name
                            }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ tire.customer_plate
                            }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if tire.giris_tarihi %}
                            {{ tire.giris_tarihi.strftime('%d.%m.%Y') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button type="button"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg transition-colors shadow-sm create-label-btn"
                                onclick="handleLabelButtonClickSafe(this)" data-tire-id="{{ tire.id }}"
                                data-seri-no="{{ tire.seri_no if tire.seri_no else '' }}"
                                data-customer-name="{{ tire.customer_name|replace("'", "&#39;")|replace('"', '&quot;') }}"
                                data-customer-phone="{{ tire.customer_phone|replace("'", "&#39;")|replace('"', '&quot;') }}"
                                data-customer-plate="{{ tire.customer_plate|replace("'", "&#39;")|replace('"', '&quot;') }}"
                                data-brand="{{ tire.brand|replace("'", "&#39;")|replace('"', '&quot;') }}"
                                data-mevsim="{{ tire.mevsim|replace("'", "&#39;")|replace('"', '&quot;') if tire.mevsim else '' }}"
                                data-rack-code="{{ tire.rack_code|replace("'", "&#39;")|replace('"', '&quot;') }}"
                                data-dis-durumu="{{ tire.dis_durumu|replace("'", "&#39;")|replace('"', '&quot;') }}"
                                data-giris-tarihi="{{ tire.giris_tarihi.strftime('%d.%m.%Y') if tire.giris_tarihi else '' }}"
                                data-tire-brands='{{ tire_brands_list|tojson|safe }}'
                                data-tire-mevsims='{{ tire_mevsims_list|tojson|safe }}'
                                data-tire-sizes='{{ tire_sizes_list|tojson|safe }}'>
                                Etiket Oluştur
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-sm text-gray-500">
                            Henüz lastik kaydı bulunmamaktadır.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Label Preview Section (Hidden by default) -->
    <div id="labelPreviewSection" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
        <h2 class="text-xl font-bold text-gray-900 mb-6">Etiket Önizleme</h2>

        <!-- Labels Preview -->
        <div id="labelsContainer" class="mb-6">
            <!-- Labels will be generated here -->
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4">
            <button onclick="generatePDF()"
                class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                PDF Oluştur
            </button>

            <button onclick="hideLabelPreview()"
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                Kapat
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    console.log('Script block loaded');

    // BACKUP: Eski ASCII dönüştürme fonksiyonu (geri dönüş için saklanıyor)
    // function convertTurkishToASCII(text) {
    //     if (!text) return '';
    //     return String(text)
    //         .replace(/İ/g, 'I').replace(/ı/g, 'i')
    //         .replace(/Ş/g, 'S').replace(/ş/g, 's')
    //         .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
    //         .replace(/Ü/g, 'U').replace(/ü/g, 'u')
    //         .replace(/Ö/g, 'O').replace(/ö/g, 'o')
    //         .replace(/Ç/g, 'C').replace(/ç/g, 'c');
    // }

    // Türkçe karakter desteği için: Artık dönüştürme yapmıyoruz, doğrudan Türkçe karakterleri kullanıyoruz
    function convertTurkishToASCII(text) {
        // Artık dönüştürme yapmıyoruz, Türkçe karakterleri olduğu gibi döndürüyoruz
        return text || '';
    }
    let currentTireId = null;

    // Function already defined in extra_head block, just verify it exists
    if (typeof window.handleLabelButtonClick === 'undefined') {
        console.error('handleLabelButtonClick function not found!');
    }


    // Make showLabelPreview globally available - this is the real implementation
    window._realShowLabelPreview = function (tireId, customerName, customerPhone, customerPlate, tireSizes, brand, mevsim, rackCode, disDurumu, girisTarihi, seriNo, tireBrands = [], tireMevsims = []) {
        try {
            console.log('_realShowLabelPreview called with:', { tireId, customerName, tireSizes, brand, mevsim, rackCode, disDurumu, seriNo });

            // Also update window.showLabelPreview to point to this function
            window.showLabelPreview = window._realShowLabelPreview;

            currentTireId = tireId;

            // Parse tire sizes
            let tireSizesArray = [];
            if (tireSizes) {
                if (Array.isArray(tireSizes)) {
                    tireSizesArray = tireSizes;
                } else if (typeof tireSizes === 'string') {
                    try {
                        tireSizesArray = JSON.parse(tireSizes);
                    } catch (e) {
                        tireSizesArray = [tireSizes];
                    }
                } else if (typeof tireSizes === 'object' && tireSizes !== null) {
                    console.warn('tireSizes is an object, attempting to convert:', tireSizes);
                    if (Object.keys(tireSizes).length > 0) {
                        tireSizesArray = Object.values(tireSizes).map(String);
                    } else {
                        tireSizesArray = [String(tireSizes)];
                    }
                }
            }

            // Parse tire brands and mevsims
            let tireBrandsArray = [];
            if (tireBrands) {
                if (Array.isArray(tireBrands)) tireBrandsArray = tireBrands;
                else if (typeof tireBrands === 'string') { try { tireBrandsArray = JSON.parse(tireBrands); } catch (e) { tireBrandsArray = [tireBrands]; } }
            }

            let tireMevsimsArray = [];
            if (tireMevsims) {
                if (Array.isArray(tireMevsims)) tireMevsimsArray = tireMevsims;
                else if (typeof tireMevsims === 'string') { try { tireMevsimsArray = JSON.parse(tireMevsims); } catch (e) { tireMevsimsArray = [tireMevsims]; } }
            }

            // Store data globally for sub-label generation
            window.currentLabelData = {
                customerName: customerName || '',
                customerPhone: customerPhone || '',
                customerPlate: customerPlate || '',
                ebat: (tireSizesArray && tireSizesArray.length > 0) ? tireSizesArray[0] : '',
                tireSizes: tireSizesArray || [],
                tireBrands: tireBrandsArray || [],
                tireMevsims: tireMevsimsArray || [],
                brand: brand || '',
                mevsim: mevsim || '',
                rackCode: rackCode || '',
                disDurumu: disDurumu || '',
                girisTarihi: girisTarihi || '',
                seriNo: seriNo || ''
            };
            console.log('Stored currentLabelData:', window.currentLabelData);

            console.log('showLabelPreview - tireSizesArray:', tireSizesArray, 'length:', tireSizesArray.length);
            console.log('showLabelPreview - window.currentLabelData:', window.currentLabelData);
            console.log('showLabelPreview - window.currentLabelData.tireSizes:', window.currentLabelData.tireSizes, 'length:', window.currentLabelData.tireSizes ? window.currentLabelData.tireSizes.length : 0);

            // Generate labels
            generateLabels();

            // Show preview section
            const previewSection = document.getElementById('labelPreviewSection');
            if (!previewSection) {
                console.error('Preview section not found');
                alert('Önizleme alanı bulunamadı. Sayfayı yenileyin.');
                return;
            }

            previewSection.classList.remove('hidden');

            // Scroll to preview section
            previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
            console.error('Error in showLabelPreview:', error);
            alert('Etiket önizleme oluşturulurken bir hata oluştu: ' + error.message);
        }
    }

    function hideLabelPreview() {
        document.getElementById('labelPreviewSection').classList.add('hidden');
        currentTireId = null;
    }

    function getLabelData() {
        // Get data from stored object (no input fields needed)
        const data = window.currentLabelData || {
            customerName: '',
            customerPhone: '',
            brand: '',
            mevsim: '', // Mevsim bilgisi
            ebat: '',
            tireSizes: [],
            rackCode: '',
            disDurumu: '',
            customerPlate: '',
            girisTarihi: '',
            seriNo: '' // Müşterinin seri numarası
        };

        // Ensure tireSizes is an array
        if (data.tireSizes && !Array.isArray(data.tireSizes)) {
            try {
                data.tireSizes = JSON.parse(data.tireSizes);
            } catch (e) {
                data.tireSizes = [];
            }
        }
        // Ensure tireBrands and tireMevsims are arrays
        if (data.tireBrands && !Array.isArray(data.tireBrands)) {
            try { data.tireBrands = JSON.parse(data.tireBrands); } catch (e) { data.tireBrands = []; }
        }
        if (data.tireMevsims && !Array.isArray(data.tireMevsims)) {
            try { data.tireMevsims = JSON.parse(data.tireMevsims); } catch (e) { data.tireMevsims = []; }
        }

        console.log('getLabelData - returning data:', data, 'tireSizes:', data.tireSizes);
        return data;
    }

    function generateLabels() {
        try {
            const data = getLabelData();
            const container = document.getElementById('labelsContainer');

            if (!container) {
                console.error('Labels container not found');
                return;
            }

            // Determine number of depot labels based on tire sizes
            // If no tire sizes, show 1 label. Otherwise show as many as tire sizes
            console.log('generateLabels - data:', data);
            console.log('generateLabels - data.tireSizes:', data.tireSizes, 'type:', typeof data.tireSizes, 'isArray:', Array.isArray(data.tireSizes), 'length:', data.tireSizes ? data.tireSizes.length : 0);

            // Ensure tireSizes/brands/mevsims are arrays
            let tireSizesArray = [];
            let tireBrandsArray = [];
            let tireMevsimsArray = [];

            if (data.tireSizes) {
                if (Array.isArray(data.tireSizes)) {
                    tireSizesArray = data.tireSizes;
                } else if (typeof data.tireSizes === 'string') {
                    try {
                        tireSizesArray = JSON.parse(data.tireSizes);
                    } catch (e) {
                        tireSizesArray = [data.tireSizes];
                    }
                }
            }
            if (data.tireBrands) {
                if (Array.isArray(data.tireBrands)) {
                    tireBrandsArray = data.tireBrands;
                } else if (typeof data.tireBrands === 'string') {
                    try { tireBrandsArray = JSON.parse(data.tireBrands); } catch (e) { tireBrandsArray = []; }
                }
            }
            if (data.tireMevsims) {
                if (Array.isArray(data.tireMevsims)) {
                    tireMevsimsArray = data.tireMevsims;
                } else if (typeof data.tireMevsims === 'string') {
                    try { tireMevsimsArray = JSON.parse(data.tireMevsims); } catch (e) { tireMevsimsArray = []; }
                }
            }

            // We show ALL tires on ONE depot label
            const depotLabelCount = tireSizesArray.length > 0 ? tireSizesArray.length : 1;
            console.log('generateLabels - Counts:', { sizes: tireSizesArray.length, brands: tireBrandsArray.length, mevsims: tireMevsimsArray.length, depotLabels: depotLabelCount });

            // Single depot label sizing
            let labelWidth = '90mm';
            let labelHeight = '70mm';
            let labelMargin = '8mm';
            let cols = Math.min(2, depotLabelCount);

            // Update data.tireSizes to ensure it's an filtered array
            data.tireSizes = tireSizesArray;
            data.tireBrands = tireBrandsArray;
            data.tireMevsims = tireMevsimsArray;

            let html = '<div id="printArea" class="flex flex-col items-center" style="font-family: \'Poppins\', sans-serif; padding: 20px;">';

            // Depo Etiketleri (1 adet - tüm lastikleri gösterir)
            html += '<div class="mb-4">';
            html += '<h3 class="text-lg font-semibold text-gray-800 mb-4 text-center no-print">Depo Etiketleri (' + depotLabelCount + ' adet)</h3>';

            // Calculate grid layout based on count
            let rowCount;
            if (depotLabelCount <= 4) {
                rowCount = Math.ceil(depotLabelCount / cols);
            } else if (depotLabelCount === 5) {
                rowCount = 4; // 2-2-2-1 layout
                cols = 2;
            } else if (depotLabelCount === 6) {
                rowCount = 4; // 2-2-2-2 layout
                cols = 2;
            } else {
                rowCount = Math.ceil(depotLabelCount / cols);
            }

            // Create grid with proper rows
            html += '<div style="display: grid; grid-template-columns: repeat(' + cols + ', 1fr); gap: ' + labelMargin + '; justify-items: center;">';

            // Create depot labels (one per tire)
            console.log('Creating', depotLabelCount, 'depot labels with tireSizesArray:', tireSizesArray);
            console.log('Data object:', data);

            // Ensure data.tireSizes is set to the filtered array
            const labelData = { ...data };
            labelData.tireSizes = tireSizesArray;
            labelData.tireBrands = tireBrandsArray;
            labelData.tireMevsims = tireMevsimsArray;

            // Müşterinin seri numarası - tüm etiketlerde aynı
            const seriNo = data.seriNo || '';

            // Create depot labels
            for (let i = 0; i < depotLabelCount; i++) {
                html += createDepoLabel(labelData, labelWidth, labelHeight, seriNo);
            }

            html += '</div>';
            html += '</div>';

            // Müşteri Etiketi (Genişletilmiş)
            html += '<div class="mb-10">';
            html += '<h3 class="text-lg font-semibold text-gray-800 mb-4 text-center no-print">Müşteri Etiketi</h3>';
            html += '<div class="flex justify-center">';
            // Önizlemede daha büyük ve okunaklı olması için genişletildi (İşyeri etiketi kaldırıldı)
            html += createMusteriLabel(data, '120mm', '100mm', seriNo);
            html += '</div>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        } catch (error) {
            console.error('Error in generateLabels:', error);
            alert('Etiketler oluşturulurken bir hata oluştu: ' + error.message);
        }
    }

    function updateLabels() {
        generateLabels();
    }

    function createDepoLabel(data, width, height, seriNo) {

        /* =========================
           VERI HAZIRLIGI
           ========================= */

        const raf = String(data.rackCode || '').trim();
        const plaka = String(data.customerPlate || '').trim();
        const seri = String(seriNo || '').trim();

        const customerName = String(data.customerName || '').trim();
        const girisTarihi = String(data.girisTarihi || '').trim();

        let sizes = [];
        let brands = [];

        if (Array.isArray(data.tireSizes)) {
            sizes = data.tireSizes.filter(s => s && String(s).trim() !== '');
        }

        if (Array.isArray(data.tireBrands)) {
            brands = data.tireBrands;
        }

        // 4 lastik hedefi (fazlası için sonra konuşacağız)
        const maxRows = Math.min(4, Math.max(sizes.length, 1));

        const rows = [];
        for (let i = 0; i < maxRows; i++) {
            rows.push({
                size: sizes[i] || '-',
                brand: brands[i] || '-'
            });
        }

        /* =========================
           HTML
           ========================= */

        return `
            <div class="depo-label" style="width:${width}; height:${height}; display: flex; flex-direction: column; justify-content: space-between;">

                <!-- UST SATIR -->
                <div class="depo-header" style="display: flex; justify-content: space-between; align-items: baseline; font-weight: 800; font-size: 16pt; color: #111; margin-bottom: 2mm;">
                    <div style="font-size: 18pt;">${escapeHtml(raf)}</div>
                    <div style="flex:1; text-align:center;">${escapeHtml(plaka)}</div>
                    <div style="font-size: 18pt;">${escapeHtml(seri)}</div>
                </div>

                <!-- GOVDE -->
                <div class="depo-content" style="flex: 1; display: flex; flex-direction: column;">

                    <div class="depo-customer" style="font-size: 11pt; font-weight: 700; color: #111; margin-bottom: 2mm; border-bottom: 1px solid #ddd; padding-bottom: 1mm;">
                        ${escapeHtml(customerName)}
                    </div>

                    <div class="depo-table" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1mm 4mm; font-size: 9.5pt; font-weight: 700; color: #111;">
                        <div style="font-size: 8pt; color: #666; font-weight: 800;">EBAT</div>
                        <div style="font-size: 8pt; color: #666; font-weight: 800;">MARKA</div>

                        ${rows.map(r => `
                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(String(r.size))}</div>
                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(String(r.brand))}</div>
                        `).join('')}
                    </div>

                </div>

                <div class="depo-footer" style="margin-top: auto; font-size: 9pt; font-weight: 600; color: #444; border-top: 1px solid #eee; padding-top: 1mm;">
                    ${escapeHtml(girisTarihi)}
                </div>

            </div>
        `;
    }



    function createMusteriLabel(data, width, height, seriNo) {
        // Genişletilmiş boyut kontrolü (Önizleme için)
        const isExpanded = parseFloat(width) > 100;
        const headerTitleStyle = isExpanded ? 'font-size: 14pt; margin-bottom: 1.5mm;' : '';
        const headerSubStyle = isExpanded ? 'font-size: 9pt; margin-bottom: 3mm;' : '';
        const contentStyle = isExpanded ? 'font-size: 8.5pt; line-height: 1.3;' : '';
        const fieldStyle = isExpanded ? 'width: 32mm; font-size: 8.5pt;' : '';
        const logoStyle = isExpanded ? 'max-width: 65px; max-height: 50px; margin-bottom: 1.5mm;' : '';
        const phoneStyle = isExpanded ? 'font-size: 9.5pt; margin-top: auto; padding-top: 3mm; border-top: 1px solid #eee;' : '';

        // Prepare per-tire rows (ebat / marka / mevsim)
        let tireSizesArray = data.tireSizes || [];
        let tireBrandsArray = data.tireBrands || [];
        let tireMevsimsArray = data.tireMevsims || [];

        // Ensure we take the maximum count
        const rowCount = Math.max(tireSizesArray.length, tireBrandsArray.length, tireMevsimsArray.length) || 0;
        const isTight = rowCount > 4;

        let tableFont = isTight ? '5pt' : '6pt';
        if (isExpanded) tableFont = isTight ? '7.5pt' : '8.5pt';

        const rowGap = isTight ? '0.2mm' : '0.5mm';
        const colGap = isTight ? '1mm' : '2mm';
        let tireTableHtml = '<div style="display:inline-block; vertical-align:top; margin-left:0;">';
        tireTableHtml += `<div style="display:grid; grid-template-columns: repeat(3, auto); gap: ${rowGap} ${colGap}; font-size:${tableFont}; line-height:1.1;">`;
        tireTableHtml += '<span style="font-weight:700;">Ebat</span><span style="font-weight:700;">Marka</span><span style="font-weight:700;">Mevsim</span>';

        if (rowCount > 0) {
            for (let i = 0; i < rowCount; i++) {
                // Fix: Don't fallback to global data.ebat/brand for rows. Use '-' if empty.
                const sizeVal = tireSizesArray[i] || '-';
                const brandVal = tireBrandsArray[i] || '-';
                const mevVal = tireMevsimsArray[i] || '-';
                tireTableHtml += `<span>${escapeHtml(String(sizeVal))}</span><span>${escapeHtml(String(brandVal))}</span><span>${escapeHtml(String(mevVal))}</span>`;
            }
        } else {
            tireTableHtml += `<span>${escapeHtml(String(data.ebat || '-'))}</span><span>${escapeHtml(String(data.brand || '-'))}</span><span>${escapeHtml(String(data.mevsim || '-'))}</span>`;
        }
        tireTableHtml += '</div></div>';

        const seriNoStr = String(seriNo || '').trim();
        let seriNoHtml = '';
        if (seriNoStr && seriNoStr !== '') {
            let seriNoFontSize = isExpanded ? '11pt' : '8pt';
            seriNoHtml = `<div class="label-seri-no" style="font-size: ${seriNoFontSize};">${escapeHtml(seriNoStr)}</div>`;
        }

        return `
            <div class="musteri-label" style="width: ${width}; height: ${height};">
                <div class="label-header">
                    ${seriNoHtml}
                    <img src="/static/images/Nusretler logo-Photoroom.png" alt="Logo" class="label-logo" style="${logoStyle}">
                    <div class="label-title-main" style="${headerTitleStyle}">NUSRETLER LASTİK & SİGORTA</div>
                    <div class="label-title-sub" style="${headerSubStyle}">Müşteri Etiketi</div>
                </div>
                <div class="label-content" style="${contentStyle}">
                    <div><span class="label-field" style="${fieldStyle}">İsim:</span> <span class="label-value">${escapeHtml(data.customerName)}</span></div>
                    <div><span class="label-field" style="${fieldStyle}">Telefon:</span> <span class="label-value">${escapeHtml(data.customerPhone)}</span></div>
                    <div style="margin-bottom: 1mm;">
                        <span class="label-field" style="${fieldStyle}">Lastik Bilgisi:</span>
                        ${tireTableHtml}
                    </div>
                    <div><span class="label-field" style="${fieldStyle}">Raf Kodu:</span> <span class="label-value" style="font-weight:700;">${escapeHtml(data.rackCode)}</span></div>
                    <div><span class="label-field" style="${fieldStyle}">Diş Durumu:</span> <span class="label-value">${escapeHtml(data.disDurumu)}</span></div>
                    <div><span class="label-field" style="${fieldStyle}">Plaka:</span> <span class="label-value" style="font-weight:700;">${escapeHtml(data.customerPlate)}</span></div>
                    <div><span class="label-field" style="${fieldStyle}">Giriş Tarihi:</span> <span class="label-value">${escapeHtml(data.girisTarihi)}</span></div>
                    <div class="label-phone-numbers" style="text-align: center; font-weight: 600; color: #1a1a1a; ${phoneStyle}">0537 873 74 14  |  0544 644 46 00</div>
                </div>
            </div>
        `;
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Türkçe karakter desteği için Roboto font'u ekleniyor
    // jsPDF'in helvetica font'u Türkçe karakterleri desteklemediği için custom font gerekiyor
    // Geri dönüş için: Bu bölümü silip helvetica font'una geri dönebilirsiniz

    // Roboto Regular font (base64) - Türkçe karakterleri destekler
    // Bu font jsPDF font converter ile oluşturulmuştur
    // Font dosyası çok büyük olduğu için CDN'den yükleniyor
    let robotoFontLoaded = false;

    // Font yükleme fonksiyonu
    async function loadRobotoFont(doc) {
        if (robotoFontLoaded) return; // Zaten yüklü

        try {
            // jsPDF'in font converter'ını kullanarak Roboto font'unu eklemek gerekiyor
            // Ancak bu çok büyük dosya boyutu oluşturur

            // Alternatif: jsPDF'in yeni versiyonlarında UTF-8 desteği var
            // Ama helvetica font'u Türkçe karakterleri desteklemiyor

            // En iyi çözüm: jsPDF font converter kullanarak Roboto font'unu eklemek
            // Font converter: https://raw.githack.com/MrRio/jsPDF/master/fontconverter/fontconverter.html

            // Şimdilik: jsPDF'in built-in font'larından birini kullanacağız
            // Ancak helvetica Türkçe karakterleri desteklemiyor

            // Geçici çözüm: Türkçe karakterleri ASCII'ye çevirmek
            // Ama kullanıcı Türkçe karakter desteği istiyor

            // En iyi çözüm: jsPDF font converter kullanarak Roboto font'unu eklemek
            // Bu işlem için font dosyasını base64'e çevirmek gerekiyor

            console.log('Roboto font yükleme - jsPDF custom font desteği gerekiyor');
            robotoFontLoaded = true;
        } catch (error) {
            console.error('Font yükleme hatası:', error);
        }
    }

    // Global variable to store logo as base64
    let logoBase64 = null;

    // Load logo and convert to base64
    function loadLogoAsBase64(callback) {
        if (logoBase64) {
            callback(logoBase64);
            return;
        }

        const logoImg = new Image();
        logoImg.crossOrigin = 'anonymous';
        logoImg.onload = function () {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = logoImg.width;
                canvas.height = logoImg.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(logoImg, 0, 0);
                logoBase64 = canvas.toDataURL('image/png');
                callback(logoBase64);
            } catch (e) {
                console.warn('Logo base64 çevrilemedi:', e);
                callback(null);
            }
        };
        logoImg.onerror = function () {
            console.warn('Logo yüklenemedi');
            callback(null);
        };
        logoImg.src = '/static/images/Nusretler logo-Photoroom.png';
    }
    function generatePDF() {
        const { jsPDF } = window.jspdf;

        // ÖZEL SAYFA: 105 x 210 mm
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: [105, 210],
            compress: true
        });

        const data = getLabelData();

        // Logo depo etiketinde kullanılmayacak ama mevcut akışa dokunmuyoruz
        loadLogoAsBase64(function (logoData) {
            generatePDFWithLogo(doc, data, logoData);
        });
    }
    function generatePDFWithLogo(doc, data, logoData) {
        // Sayfa ölçüsü (105 x 210)
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // Boşluklar
        const pageMargin = 5;
        const gapY = 5;

        // 1 sayfada 3 depo etiketi
        const labelsPerPage = 3;

        // Etiket boyutu
        const labelWidth = pageWidth - 2 * pageMargin;
        const usableHeight = pageHeight - 2 * pageMargin - (gapY * (labelsPerPage - 1));
        const labelHeight = usableHeight / labelsPerPage;

        const depotSizes = data.tireSizes || [];
        const depotBrands = data.tireBrands || [];
        const depotMevsims = data.tireMevsims || [];

        // Her lastik ebatı için bir depo etiketi, ebat yoksa bile marka/mevsim varsa oluştur
        const depotLabelCount = Math.max(depotSizes.length, depotBrands.length, depotMevsims.length) || 1;
        const seriNo = data.seriNo || '';

        let yPos = pageMargin;
        let labelsOnCurrentPage = 0;

        /* =========================
           DEPO ETİKETLERİ
           ========================= */
        for (let idx = 0; idx < depotLabelCount; idx++) {
            const sz = depotSizes[idx] || (idx === 0 ? data.ebat : '');
            if (labelsOnCurrentPage === labelsPerPage) {
                doc.addPage([105, 210], 'portrait');
                yPos = pageMargin;
                labelsOnCurrentPage = 0;
            }

            drawLabelOnPDF(
                doc,
                data,
                sz,
                pageMargin,
                yPos,
                labelWidth,
                labelHeight,
                'DEPO ETIKETI',
                logoData,
                seriNo
            );

            yPos += labelHeight + gapY;
            labelsOnCurrentPage++;
        }

        /* =========================
           MÜŞTERİ + İŞYERİ ETİKETLERİ
           (AYNI SAYFADA, ALT ALTA)
           ========================= */

        // Eğer sayfada yer yoksa yeni sayfa aç
        if (yPos + (labelHeight * 2) + gapY > pageHeight - pageMargin) {
            doc.addPage([105, 210], 'portrait');
            yPos = pageMargin;
        }

        // Müşteri etiketi (Genişletilmiş)
        // İşyeri etiketi kaldırıldı, müşteri etiketi onun yerini de kapsayacak şekilde büyütüldü
        // İki etiketlik alanı tek etiketle dolduruyoruz (yaklaşık 130-135mm)
        const expandedLabelHeight = (labelHeight * 2) + gapY;

        drawLabelOnPDF(
            doc,
            data,
            null,
            pageMargin,
            yPos,
            labelWidth,
            expandedLabelHeight,
            'MUSTERI ETIKETI',
            logoData,
            seriNo
        );

        /* =========================
           PDF KAYDET
           ========================= */
        doc.save(`depo_etiketleri_${data.customerPlate || 'etiket'}.pdf`);
    }


    function drawLabelOnPDF(doc, data, tireSize, x, y, width, height, labelType, logoData, seriNo) {
        const isDepo = labelType.includes('DEPO');
        // =========================
        // DEPO ETIKETI (YENI TASARIM)
        // =========================
        if (isDepo) {
            // Arka plan + çerçeve
            const bgColor = [249, 249, 249];
            const borderColor = [242, 107, 29];

            doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
            doc.roundedRect(x, y, width, height, 3, 3, 'F');

            doc.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
            doc.setLineWidth(0.53);
            doc.roundedRect(x, y, width, height, 3, 3);



            // İç boşluklar
            const padX = 4;
            const padTop = 6;
            const padBottom = 6;

            // ÜST SATIR: RAF | PLAKA | SERI
            const raf = String(data.rackCode || '');
            const plaka = String(data.customerPlate || '');
            const seri = String(seriNo || '');

            doc.setTextColor(17, 17, 17);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);

            const topY = y + padTop;

            // Sol: RAF
            doc.text(convertTurkishToASCII(raf), x + padX, topY, { align: 'left' });

            // Orta: PLAKA
            doc.text(convertTurkishToASCII(plaka), x + width / 2, topY, { align: 'center' });

            // Sağ: SERI
            doc.text(convertTurkishToASCII(seri), x + width - padX, topY, { align: 'right' });

            // Müşteri adı
            let currentY = topY + 10;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(convertTurkishToASCII(String(data.customerName || '')), x + padX, currentY, { align: 'left' });

            // Tablo (EBAT | MARKA) — 4 satır hedefi
            currentY += 9;

            const sizes = Array.isArray(data.tireSizes) ? data.tireSizes : [];
            const brands = Array.isArray(data.tireBrands) ? data.tireBrands : [];

            // 4 satır hedef: (6 satır gelirse sonra ayrı sayfa planlarız)
            const maxRows = sizes.length > 0 ? Math.min(4, sizes.length) : 1;


            // Kolon X’ler
            const col1X = x + padX;
            const col2X = x + (width / 2) + 2;

            // Başlık
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('EBAT', col1X, currentY);
            doc.text('MARKA', col2X, currentY);

            // Satırlar
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9.6);

            const rowGap = 6.2;
            for (let i = 0; i < maxRows; i++) {
                const ebatVal = (sizes[i] || tireSize || data.ebat || '');
                const markaVal = (brands[i] || data.brand || '');

                const rowY = currentY + rowGap * (i + 1);
                doc.text(convertTurkishToASCII(String(ebatVal)), col1X, rowY, { maxWidth: (width / 2) - 6 });
                doc.text(convertTurkishToASCII(String(markaVal)), col2X, rowY, { maxWidth: (width / 2) - 6 });
            }

            // Giriş tarihi en altta
            const dateY = y + height - padBottom;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(convertTurkishToASCII(String(data.girisTarihi || '')), x + padX, dateY, { align: 'left' });

            return; // depo etiketinde burada bitiriyoruz
        }

        const bgColor = isDepo ? [249, 249, 249] : [255, 255, 255]; // #F9F9F9 for depo, white for musteri
        const borderColor = [242, 107, 29]; // #F26B1D orange
        const titleColor = [242, 107, 29]; // #F26B1D orange
        const subtitleColor = [51, 51, 51]; // #333 dark gray (vurgulu siyah)
        const textColor = [51, 51, 51]; // #333 dark gray

        // Background
        doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
        doc.roundedRect(x, y, width, height, 3, 3, 'F');

        // Border (1.5px = 0.53mm)
        doc.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
        doc.setLineWidth(0.53);
        doc.roundedRect(x, y, width, height, 3, 3);

        // Seri numarası - sağ üst köşe (boşsa gösterme)
        const seriNoStr = String(seriNo || '').trim();
        if (seriNoStr && seriNoStr !== '') {
            const seriNoLength = seriNoStr.length;
            let seriNoFontSize = 6;
            let seriNoX = x + width - 4; // Sağdan 4mm içeride (PDF'de taşmaması için)
            // 4-5 haneli seri numaraları için font boyutunu küçült ve sağdan boşluğu artır
            if (seriNoLength >= 4) {
                seriNoFontSize = 5.5;
                seriNoX = x + width - 4.5;
            }
            if (seriNoLength >= 5) {
                seriNoFontSize = 5;
                seriNoX = x + width - 5;
            }
            doc.setFontSize(seriNoFontSize);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
            doc.text(seriNoStr, seriNoX, y + 3, { align: 'right' }); // Üstten 3mm aşağıda
        }

        // jsPDF'in helvetica font'u Türkçe karakterleri desteklemiyor
        // Bu yüzden Türkçe karakterleri ASCII'ye çevirerek kullanıyoruz
        // Geri dönüş için: Bu bölümü değiştirip Türkçe karakterleri doğrudan kullanabilirsiniz

        // Helper function to convert Turkish characters to ASCII for jsPDF compatibility
        function convertTurkishToASCII(text) {
            if (!text) return '';
            return String(text)
                .replace(/İ/g, 'I')      // Capital I with dot -> I
                .replace(/ı/g, 'i')      // Lowercase i without dot -> i
                .replace(/Ş/g, 'S')      // Capital S with cedilla -> S
                .replace(/ş/g, 's')      // Lowercase s with cedilla -> s
                .replace(/Ğ/g, 'G')      // Capital G with breve -> G
                .replace(/ğ/g, 'g')      // Lowercase g with breve -> g
                .replace(/Ü/g, 'U')      // Capital U with diaeresis -> U
                .replace(/ü/g, 'u')      // Lowercase u with diaeresis -> u
                .replace(/Ö/g, 'O')      // Capital O with diaeresis -> O
                .replace(/ö/g, 'o')      // Lowercase o with diaeresis -> o
                .replace(/Ç/g, 'C')      // Capital C with cedilla -> C
                .replace(/ç/g, 'c');     // Lowercase c with cedilla -> c
        }

        // Header & label type
        let currentY;
        const isExpanded = !isDepo && height > 100; // Check if it's a non-depot label and expanded height
        if (!isDepo) {
            if (isExpanded) {
                // Logo - Expanded
                if (logoData) {
                    try {
                        const logoWidth = width * 0.20;
                        const logoHeight = logoWidth * 0.7;
                        const logoX = x + (width - logoWidth) / 2;
                        const logoY = y + 8;
                        doc.addImage(logoData, 'PNG', logoX, logoY, logoWidth, logoHeight);
                    } catch (e) { console.warn('Logo error:', e); }
                }

                // Title - Expanded
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(titleColor[0], titleColor[1], titleColor[2]);
                const titleY = (y + 8) + ((width * 0.20) * 0.7) + 8;
                doc.text(convertTurkishToASCII('NUSRETLER LASTIK & SIGORTA'), x + width / 2, titleY, { align: 'center' });

                // Label type - Expanded
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(subtitleColor[0], subtitleColor[1], subtitleColor[2]);
                const labelTypeY = titleY + 6;
                doc.text(convertTurkishToASCII('Musteri Etiketi'), x + width / 2, labelTypeY, { align: 'center' });
                currentY = labelTypeY + 10;
            } else {
                // Logo - Normal
                if (logoData) {
                    try {
                        const logoWidth = width * 0.14;
                        const logoHeight = logoWidth * 0.7;
                        const logoX = x + (width - logoWidth) / 2;
                        const logoY = y + 3;
                        doc.addImage(logoData, 'PNG', logoX, logoY, logoWidth, logoHeight);
                    } catch (e) { console.warn('Logo error:', e); }
                }

                // Title - Normal
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(titleColor[0], titleColor[1], titleColor[2]);
                const titleY = (y + 3) + ((width * 0.14) * 0.7) + 4;
                doc.text(convertTurkishToASCII('NUSRETLER LASTIK & SIGORTA'), x + width / 2, titleY, { align: 'center' });

                // Label type - Normal
                doc.setFontSize(6.2);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(subtitleColor[0], subtitleColor[1], subtitleColor[2]);
                const labelTypeY = titleY + 3.8;
                doc.text(convertTurkishToASCII('Musteri Etiketi'), x + width / 2, labelTypeY, { align: 'center' });
                currentY = labelTypeY + 4.0;
            }
        } else {
            // Depo etiketi: logo/marka yok, tip metni yukarıda
            doc.setFontSize(8.8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(titleColor[0], titleColor[1], titleColor[2]);
            const labelTypeY = y + 5.8;
            doc.text(convertTurkishToASCII('Depo Etiketi'), x + width / 2, labelTypeY, { align: 'center' });
            currentY = labelTypeY + 5.2;
        }

        // Content sizing
        const baseFontSize = isDepo ? 8.3 : (isExpanded ? 8.5 : 5.2);
        doc.setFontSize(baseFontSize);
        const labelX = isDepo ? x + 2.0 : (isExpanded ? x + 5 : x + 1.8);
        const valueX = isDepo ? x + 21.5 : (isExpanded ? x + 28 : x + 16);
        const maxValueWidth = width - valueX - 5;

        // Reset text color to dark gray
        doc.setTextColor(textColor[0], textColor[1], textColor[2]);

        // Helper to truncate long text
        function truncate(text, maxLen) {
            const str = String(text || '');
            return str.length > maxLen ? str.substring(0, maxLen - 3) + '...' : str;
        }

        // Adjust spacing based on label height
        const spacing = isDepo ? 5.3 : (isExpanded ? 8.2 : (height < 65 ? 3.8 : 4.1));

        // İsim (Türkçe karakterler ASCII'ye çevriliyor)
        doc.setFont('helvetica', 'bold');
        doc.text('Isim:', labelX, currentY);
        doc.setFont('helvetica', 'normal');
        doc.text(truncate(convertTurkishToASCII(data.customerName || ''), 22), valueX, currentY, { maxWidth: maxValueWidth });
        currentY += spacing;

        // Telefon
        doc.setFont('helvetica', 'bold');
        doc.text('Telefon:', labelX, currentY);
        doc.setFont('helvetica', 'normal');
        doc.text(String(data.customerPhone || ''), valueX, currentY, { maxWidth: maxValueWidth });
        currentY += spacing;

        // Lastik Bilgisi - Ebat / Marka / Mevsim tablo formatında
        doc.setFont('helvetica', 'bold');
        doc.text('Lastik Bilgisi:', labelX, currentY);
        doc.setFont('helvetica', 'normal');

        let tireRows = [];
        const sizesArray = Array.isArray(data.tireSizes) ? data.tireSizes : [];
        const brandsArray = Array.isArray(data.tireBrands) ? data.tireBrands : [];
        const mevsimsArray = Array.isArray(data.tireMevsims) ? data.tireMevsims : [];

        const rowCount = Math.max(sizesArray.length, brandsArray.length, mevsimsArray.length);
        const tight = rowCount > 4;

        if (rowCount > 0) {
            for (let i = 0; i < rowCount; i++) {
                // Priority: index-specific value -> fallback to global if i=0 -> dash
                const sVal = sizesArray[i] || (i === 0 ? (tireSize || data.ebat) : '');
                const bVal = brandsArray[i] || (i === 0 ? data.brand : '');
                const mVal = mevsimsArray[i] || (i === 0 ? data.mevsim : '');

                if (sVal || bVal || mVal) {
                    tireRows.push({
                        ebat: sVal || '-',
                        marka: bVal || '-',
                        mevsim: mVal || '-'
                    });
                }
            }
        }

        // Fallback for empty rows
        if (tireRows.length === 0) {
            tireRows.push({
                ebat: tireSize || data.ebat || '-',
                marka: data.brand || '-',
                mevsim: data.mevsim || '-'
            });
        }

        // Header
        let tableY = currentY;
        const col1X = valueX;
        const col2X = valueX + (isDepo ? 25.5 : (isExpanded ? 24 : 18));
        const col3X = valueX + (isDepo ? 46.5 : (isExpanded ? 48 : 35));
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(isDepo ? 8.4 : (isExpanded ? 8.0 : baseFontSize));
        doc.text('Ebat', col1X, tableY);
        doc.text('Marka', col2X, tableY);
        doc.text('Mevsim', col3X, tableY);
        const rowSpacing = tight ? (isDepo ? 3.45 : (isExpanded ? 4.2 : 2.3)) : (isDepo ? 4.4 : (isExpanded ? 6.0 : 3.2));
        tableY += rowSpacing;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(isDepo ? (tight ? 7.4 : 7.9) : (isExpanded ? (tight ? 7.0 : 8.0) : (tight ? 4.8 : baseFontSize)));

        tireRows.forEach(r => {
            doc.text(convertTurkishToASCII(String(r.ebat)), col1X, tableY, { maxWidth: isDepo ? 24 : 20 });
            doc.text(convertTurkishToASCII(String(r.marka)), col2X, tableY, { maxWidth: isDepo ? 21 : 20 });
            doc.text(convertTurkishToASCII(String(r.mevsim)), col3X, tableY, { maxWidth: isDepo ? 21 : 20 });
            tableY += rowSpacing;
        });
        doc.setFontSize(baseFontSize);
        currentY = tableY - 0.4;

        // Raf Kodu (badge)
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(isDepo ? 9.4 : baseFontSize);
        doc.text('Raf Kodu:', labelX, currentY);
        const badgeText = String(data.rackCode || '');
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(isDepo ? 10.4 : (isExpanded ? 13 : 5.2)); // Depo için daha büyük
        doc.text(badgeText, valueX, currentY, { maxWidth: maxValueWidth });
        // restore to normal after
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(baseFontSize);
        currentY += spacing;

        if (!isDepo) {
            // Diş Durumu (Türkçe karakterler ASCII'ye çevriliyor)
            doc.setFont('helvetica', 'bold');
            doc.text('Dis Durumu:', labelX, currentY);
            doc.setFont('helvetica', 'normal');
            doc.text(truncate(convertTurkishToASCII(data.disDurumu || ''), 22), valueX, currentY, { maxWidth: maxValueWidth });
            currentY += spacing;
        }

        // Plaka
        doc.setFont('helvetica', 'bold');
        doc.text('Plaka:', labelX, currentY);
        doc.setFont('helvetica', 'normal');
        doc.text(String(data.customerPlate || ''), valueX, currentY, { maxWidth: maxValueWidth });
        currentY += spacing;

        // Giriş Tarihi
        doc.setFont('helvetica', 'bold');
        doc.text(convertTurkishToASCII('Giriş Tarihi:'), labelX, currentY);
        doc.setFont('helvetica', 'normal');
        doc.text(String(data.girisTarihi || ''), valueX, currentY, { maxWidth: maxValueWidth });
        currentY += spacing;

        if (!isDepo) {
            // Firma Telefon Numaraları (en altta, ortalanmış)
            doc.setFontSize(isExpanded ? 8.5 : (tight ? 5.0 : 5.5));
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(26, 26, 26);
            const phoneY = y + height - (isExpanded ? 4 : 3.5);
            doc.text('0537 873 74 14  |  0544 644 46 00', x + width / 2, phoneY, { align: 'center' });
        }
    }
    function printLabels() {
        const data = getLabelData();

        // tireSizes / brands array güvenliği
        let tireSizesArray = [];
        let tireBrandsArray = [];
        if (data.tireSizes) {
            if (Array.isArray(data.tireSizes)) {
                tireSizesArray = data.tireSizes.filter(s => s && String(s).trim() !== '');
            } else if (typeof data.tireSizes === 'string') {
                try { tireSizesArray = JSON.parse(data.tireSizes).filter(s => s && String(s).trim() !== ''); }
                catch (e) { tireSizesArray = [data.tireSizes].filter(s => s && String(s).trim() !== ''); }
            }
        }
        if (data.tireBrands) {
            if (Array.isArray(data.tireBrands)) tireBrandsArray = data.tireBrands;
            else if (typeof data.tireBrands === 'string') { try { tireBrandsArray = JSON.parse(data.tireBrands); } catch (e) { } }
        }

        const depotLabelCount = tireSizesArray.length > 0 ? tireSizesArray.length : 1;

        // SAYFA: 105 x 210 mm
        const pageW = '105mm';
        const pageH = '210mm';

        // Boşluklar
        const pageMargin = 5; // mm
        const gap = 5;        // mm

        // Etiket boyutu: 3 adet sığacak şekilde
        // Yükseklik = (210 - (2*margin) - (2*gap)) / 3 ≈ 63.3mm
        const labelWidth = `calc(${pageW} - ${pageMargin * 2}mm)`;
        const labelHeight = `calc((${pageH} - ${pageMargin * 2}mm - ${gap * 2}mm) / 3)`;

        const printWindow = window.open('', '_blank');

        const labelData = { ...data };
        labelData.tireSizes = tireSizesArray;
        labelData.tireBrands = tireBrandsArray;

        const seriNo = data.seriNo || '';

        // SADECE DEPO ETIKETLERI
        const allLabels = [];
        for (let i = 0; i < depotLabelCount; i++) {
            const tireSize = tireSizesArray[i] || data.ebat || '';
            allLabels.push(createDepoLabel(labelData, tireSize, '95mm', '63mm', seriNo));
        }

        // HTML: tek kolon, sayfa başına 3 etiket
        let labelsHTML = `<div id="printArea" style="font-family: 'Poppins', sans-serif; width:${pageW}; height:${pageH}; margin:0 auto; padding:${pageMargin}mm; box-sizing:border-box; display:flex; flex-direction:column;">`;

        allLabels.forEach((label, idx) => {
            const isEndOfPage = ((idx + 1) % 3 === 0) || (idx === allLabels.length - 1);
            const marginBottom = isEndOfPage ? '0' : `${gap}mm`;

            labelsHTML += `<div class="label-wrapper" style="width:100%; height:${labelHeight}; margin-bottom:${marginBottom}; page-break-inside:avoid;">${label}</div>`;

            if ((idx + 1) % 3 === 0 && idx !== allLabels.length - 1) {
                labelsHTML += `<div class="page-break"></div>`;
            }
        });

        labelsHTML += `</div>`;

        // Mevcut style tag’lerini al (depo-label border vs.)
        let cssContent = '';
        const styleTags = document.querySelectorAll('style');
        styleTags.forEach(tag => { cssContent += tag.textContent + '\n'; });

        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Depo Etiketleri</title>
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
            <style>
                @page {
                    size: 105mm 210mm;
                    margin: 0;
                }
                body {
                    font-family: 'Poppins', sans-serif;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                ${cssContent}
                .no-print { display: none !important; }
                .label-wrapper { width: 100%; }
                .page-break { page-break-after: always; }
            </style>
        </head>
        <body>
            ${labelsHTML}
        </body>
        </html>
    `);

        printWindow.document.close();

        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }


</script>
{% endblock %}