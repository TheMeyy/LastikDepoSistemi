{% extends "base.html" %}

{% block title %}Raflar - Lastik Depo Sistemi{% endblock %}

{% block content %}
<div class="animate-fade-in pb-20">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Raflar</h1>
        <button onclick="showAddForm()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Yeni Raf Grubu
        </button>
    </div>

    <!-- Add Rack Form (Modal) -->
    <div id="addRackModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-lg w-full mx-4">
            <h3 class="text-xl font-semibold text-gray-900 mb-6" id="addRackTitle">Yeni Raf Grubu Oluştur</h3>
            <form id="addRackForm" class="space-y-4">
                <div id="raf_adi_container">
                    <label for="raf_adi" class="block text-sm font-medium text-gray-700 mb-1.5">Raf Grubu Adı *</label>
                    <input type="text" id="raf_adi"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all font-semibold"
                        required>
                    <p class="text-xs text-gray-500 mt-1">Grup adı (Harf, sayı ve boşluk içerebilir)</p>
                </div>
                <div>
                    <label for="sayi" class="block text-sm font-medium text-gray-700 mb-1.5" id="sayi_label">Toplam Raf
                        Sayısı *</label>
                    <input type="number" id="sayi"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                        required min="1" max="100">
                    <p class="text-xs text-gray-500 mt-1" id="sayi_hint">Sıralı olarak oluşturulacaktır (Örn: 8 → A-1,
                        A-2... A-8)</p>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideAddForm()"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-6 py-2.5 rounded-lg transition-colors">
                        İptal
                    </button>
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-2.5 rounded-lg transition-colors shadow-sm">
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Settings Button Template -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-8 border-b border-gray-100 pb-4">
            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
                Depo Durumu
            </h2>
            <div class="flex items-center space-x-4">
                <span
                    class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full border border-indigo-100 uppercase tracking-wider">
                    Toplam: {{ total_racks|default(0) }} Raf
                </span>
            </div>
        </div>

        {% if rack_groups %}
        <div class="space-y-10">
            {% for group in rack_groups %}
            <div class="rack-group group">
                <!-- Group Header -->
                <div class="mb-4 flex items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <div class="flex items-center">
                        <div
                            class="min-w-[2.5rem] h-10 px-3 bg-white rounded-lg border border-gray-300 flex items-center justify-center font-bold text-indigo-600 shadow-sm mr-4 whitespace-nowrap">
                            {% if group.prefix|length > 6 and ' ' in group.prefix %}
                            {% set words = group.prefix.split(' ') %}
                            {% for word in words %}{{ word[0]|upper }}{% endfor %}
                            {% else %}
                            {{ group.prefix }}
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">{{ group.prefix }} Grubu</h3>
                            <span class="text-xs text-gray-500 font-medium">{{ group.racks|length }} adet raf
                                mevcuttur</span>
                        </div>
                    </div>

                    <!-- Settings Dropdown -->
                    <div class="relative inline-block text-left" id="dropdown-{{ loop.index }}">
                        <button onclick="toggleDropdown({{ loop.index }})"
                            class="p-2 hover:bg-gray-200 rounded-lg transition-colors border border-gray-300 text-gray-600 bg-white shadow-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <div id="dropdown-menu-{{ loop.index }}"
                            class="hidden absolute right-0 mt-2 w-48 rounded-xl shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-40 overflow-hidden">
                            <div class="py-1">
                                <button onclick="showAddMoreRacks('{{ group.prefix }}', {{ group.racks|length }})"
                                    class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center border-b border-gray-100">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Raf Ekle
                                </button>
                                <button
                                    onclick="showBulkDeleteModal(this.dataset.prefix, JSON.parse(this.dataset.racks))"
                                    data-prefix="{{ group.prefix }}" data-racks='{{ group.racks|tojson|safe }}'
                                    class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                    Raf Sil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Racks in this group -->
                <div class="flex flex-wrap gap-4 px-2">
                    {% for rack in group.racks %}
                    <div class="rack-item relative group/item transition-all duration-200"
                        style="flex: 0 0 auto; width: 100px;">
                        <input type="hidden" name="rack_data_{{ rack.id }}" id="rack_data_{{ rack.id }}"
                            value='{{ rack|tojson|safe }}'>
                        <div onclick="const data = JSON.parse(document.getElementById('rack_data_{{ rack.id }}').value); showRackInfo(data.kod, data.durum, data.tire_count, data.customer_name)"
                            class="w-full aspect-square rounded-xl border-2 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center p-2 relative overflow-hidden shadow-sm hover:shadow-md
                            {% if rack.durum == 'Boş' %}
                                bg-emerald-50 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300
                            {% else %}
                                bg-rose-50 border-rose-200 hover:bg-rose-100 hover:border-rose-300
                            {% endif %}">

                            <!-- Background Pattern/Icon -->
                            <div
                                class="absolute -right-2 -bottom-2 opacity-10 text-gray-900 transition-transform group-hover/item:scale-110">
                                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                            </div>

                            <span
                                class="text-[11px] leading-tight font-bold text-gray-800 z-10 text-center break-words px-1">{{
                                rack.kod }}</span>
                            <div class="mt-1 flex space-x-0.5 z-10">
                                {% if rack.durum == 'Boş' %}
                                <span
                                    class="text-[9px] uppercase font-black text-emerald-600 tracking-tighter">BOŞ</span>
                                {% else %}
                                <span class="text-[9px] uppercase font-black text-rose-600 tracking-tighter">DOLU</span>
                                {% endif %}
                            </div>
                        </div>


                        <!-- Tooltip on hover -->
                        <div
                            class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg shadow-xl opacity-0 group-hover/item:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap z-30 text-center min-w-[120px]">
                            <div class="font-bold border-b border-gray-700 pb-1 mb-1">{{ rack.kod }}</div>
                            {% if rack.durum == 'Boş' %}
                            <span class="text-emerald-400">Raf şu an boş</span>
                            {% else %}
                            <div class="text-gray-300">Müşteri: <span class="text-white">{{ rack.customer_name }}</span>
                            </div>
                            {% endif %}
                            <div class="mt-1 text-[10px] text-gray-500 italic">Bilgi için tıkla</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Legend -->
        <div
            class="mt-12 flex items-center justify-center space-x-10 text-sm font-medium border-t border-gray-100 pt-8">
            <div class="flex items-center space-x-3 group">
                <div
                    class="w-6 h-6 bg-emerald-50 border-2 border-emerald-300 rounded-lg group-hover:scale-110 transition-transform shadow-sm">
                </div>
                <span class="text-gray-600">Boş Raf</span>
            </div>
            <div class="flex items-center space-x-3 group">
                <div
                    class="w-6 h-6 bg-rose-50 border-2 border-rose-300 rounded-lg group-hover:scale-110 transition-transform shadow-sm">
                </div>
                <span class="text-gray-600">Dolu Raf</span>
            </div>
        </div>
        {% else %}
        <div class="text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-500">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
            </div>
            <p class="text-gray-500 font-medium">Henüz hiçbir raf kaydı bulunmamaktadır.</p>
            <p class="text-gray-400 text-sm mt-1">Sistemi kullanmaya başlamak için yukarıdaki butondan ilk raf grubunu
                oluşturun.</p>
        </div>
        {% endif %}
    </div>

    <!-- Rack Info Modal -->
    <div id="rackInfoModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full animate-scale-up">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Raf Detayları</h3>
                <button onclick="hideRackInfo()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="space-y-6">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <span class="text-gray-500 font-medium">Raf Kodu</span>
                    <span class="text-xl font-black text-indigo-600" id="info_rack_code"></span>
                </div>

                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <span class="text-gray-500 font-medium">Durum</span>
                    <span class="px-4 py-1 rounded-full font-bold text-sm uppercase tracking-wider"
                        id="info_rack_status"></span>
                </div>

                <div id="customer_info_row" class="p-4 bg-white border-2 border-indigo-100 rounded-xl hidden">
                    <div class="flex flex-col">
                        <span class="text-xs text-indigo-500 font-bold uppercase mb-1">Kayıtlı Müşteri</span>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2 text-indigo-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="text-lg font-bold text-gray-900" id="info_customer_name"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <button onclick="hideRackInfo()"
                    class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl hover:bg-black transition-colors shadow-lg">
                    ANLADIM
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div id="bulkDeleteModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full max-h-[90vh] flex flex-col animate-scale-up">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Raf Silme</h3>
                    <p class="text-gray-500 text-sm mt-1" id="bulkDeleteSubtitle"></p>
                </div>
                <button onclick="hideBulkDeleteModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                <p
                    class="text-sm font-medium text-gray-700 mb-4 bg-amber-50 p-4 rounded-xl border border-amber-100 text-amber-800 flex items-start">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Sadece boş durumdaki rafları seçip silebilirsiniz. Dolu raflar seçim listenizden gizlenmiştir.
                </p>

                <div id="bulkDeleteRackList" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 mt-4">
                    <!-- Checkboxes will be injected here -->
                </div>
            </div>

            <div class="mt-8 flex space-x-4 border-t border-gray-100 pt-6">
                <button onclick="hideBulkDeleteModal()"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 rounded-xl transition-colors">
                    İPTAL
                </button>
                <button id="confirmBulkDeleteBtn" onclick="confirmBulkDelete()"
                    class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 rounded-xl transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    SEÇİLENLERİ SİL
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmActionModal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full animate-scale-up text-center border border-gray-100">
            <div
                class="w-20 h-20 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Emin misiniz?</h3>
            <p id="confirmMessage" class="text-gray-500 mb-8 px-4 leading-relaxed"></p>
            <div class="flex space-x-3">
                <button id="cancelConfirmBtn"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-4 rounded-xl transition-all active:scale-95">
                    VAZGEÇ
                </button>
                <button id="okConfirmBtn"
                    class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-rose-200 active:scale-95">
                    SİL
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .animate-scale-up {
        animation: scaleUp 0.3s ease-out;
    }

    @keyframes scaleUp {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #ccc;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Toggle Settings Dropdown
    function toggleDropdown(id) {
        const menus = document.querySelectorAll('[id^="dropdown-menu-"]');
        menus.forEach(menu => {
            if (menu.id !== `dropdown-menu-${id}`) menu.classList.add('hidden');
        });

        const menu = document.getElementById(`dropdown-menu-${id}`);
        menu.classList.toggle('hidden');

        // Auto close when clicking outside
        const closeOnClickOutside = (e) => {
            if (!document.getElementById(`dropdown-${id}`).contains(e.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeOnClickOutside);
            }
        };
        if (!menu.classList.contains('hidden')) {
            setTimeout(() => document.addEventListener('click', closeOnClickOutside), 10);
        }
    }

    // Show/Hide Add Form Modals
    function showAddForm() {
        document.getElementById('addRackTitle').textContent = "Yeni Raf Grubu Oluştur";
        document.getElementById('raf_adi').value = "";
        document.getElementById('raf_adi').disabled = false;
        document.getElementById('raf_adi_container').style.display = "block";
        document.getElementById('sayi').value = "";
        document.getElementById('sayi_label').textContent = "Toplam Raf Sayısı *";
        document.getElementById('sayi_hint').textContent = "Sıralı olarak oluşturulacaktır (Örn: A-1, A-2... A-8)";
        document.getElementById('addRackModal').classList.remove('hidden');
    }

    function showAddMoreRacks(prefix, currentCount) {
        document.getElementById('addRackTitle').textContent = `"${prefix}" Grubuna Raf Ekle`;
        document.getElementById('raf_adi').value = prefix;
        document.getElementById('raf_adi').disabled = true;
        document.getElementById('raf_adi_container').style.display = "none";
        document.getElementById('sayi').value = ""; // Bir şey yazmasın
        document.getElementById('sayi_label').textContent = "Yeni Toplam Raf Sayısı *";
        document.getElementById('sayi_hint').textContent = `Mevcut: ${currentCount} raf. Girilen sayıya kadar yeni raflar eklenecektir.`;
        document.getElementById('addRackModal').classList.remove('hidden');
    }

    function hideAddForm() {
        document.getElementById('addRackModal').classList.add('hidden');
        document.getElementById('addRackForm').reset();
    }

    // Rack Info Logic
    function showRackInfo(code, status, tireCount, customerName) {
        document.getElementById('info_rack_code').textContent = code;
        const statusElement = document.getElementById('info_rack_status');
        statusElement.textContent = status;

        if (status === 'Boş') {
            statusElement.className = 'px-4 py-1 rounded-full font-bold text-sm uppercase tracking-wider bg-emerald-100 text-emerald-700 border border-emerald-200';
        } else {
            statusElement.className = 'px-4 py-1 rounded-full font-bold text-sm uppercase tracking-wider bg-rose-100 text-rose-700 border border-rose-200';
        }

        const customerRow = document.getElementById('customer_info_row');
        const customerNameEl = document.getElementById('info_customer_name');
        if (status !== 'Boş' && customerName) {
            customerNameEl.textContent = customerName;
            customerRow.classList.remove('hidden');
        } else {
            customerRow.classList.add('hidden');
        }

        document.getElementById('rackInfoModal').classList.remove('hidden');
    }

    function hideRackInfo() {
        document.getElementById('rackInfoModal').classList.add('hidden');
    }

    // Bulk Delete Logic
    let racksToDelete = [];

    function showBulkDeleteModal(prefix, racks) {
        racksToDelete = [];
        document.getElementById('bulkDeleteSubtitle').textContent = `"${prefix}" grubundaki silebileceğiniz boş raflar`;

        const listContainer = document.getElementById('bulkDeleteRackList');
        listContainer.innerHTML = '';

        const emptyRacks = racks.filter(r => r.durum === 'Boş');

        if (emptyRacks.length === 0) {
            listContainer.innerHTML = '<div class="col-span-full py-8 text-center text-gray-400 font-medium">Bu grupta silinebilir boş raf bulunamadı.</div>';
            document.getElementById('confirmBulkDeleteBtn').disabled = true;
        } else {
            emptyRacks.forEach(rack => {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `
                <input type="checkbox" id="del-rack-${rack.id}" value="${rack.id}" class="peer hidden" onchange="updateDeleteList(${rack.id}, this.checked)">
                <label for="del-rack-${rack.id}" class="flex flex-col items-center justify-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 peer-checked:bg-rose-50 peer-checked:border-rose-300 peer-checked:text-rose-700 transition-all">
                    <span class="text-sm font-bold">${rack.kod}</span>
                </label>
            `;
                listContainer.appendChild(div);
            });
            document.getElementById('confirmBulkDeleteBtn').disabled = true; // Initial state
        }

        document.getElementById('bulkDeleteModal').classList.remove('hidden');
    }

    function updateDeleteList(id, isChecked) {
        if (isChecked) {
            racksToDelete.push(id);
        } else {
            racksToDelete = racksToDelete.filter(rackId => rackId !== id);
        }
        document.getElementById('confirmBulkDeleteBtn').disabled = (racksToDelete.length === 0);
        document.getElementById('confirmBulkDeleteBtn').textContent = racksToDelete.length > 0 ? `${racksToDelete.length} RAFI SİL` : 'SEÇİLENLERİ SİL';
    }

    function hideBulkDeleteModal() {
        document.getElementById('bulkDeleteModal').classList.add('hidden');
        racksToDelete = [];
    }

    function showConfirmModal(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmActionModal');
            const msgEl = document.getElementById('confirmMessage');
            const okBtn = document.getElementById('okConfirmBtn');
            const cancelBtn = document.getElementById('cancelConfirmBtn');

            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const handleOk = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(true);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(false);
            };

            const cleanup = () => {
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            okBtn.addEventListener('click', handleOk);
            cancelBtn.addEventListener('click', handleCancel);
        });
    }

    async function confirmBulkDelete() {
        if (racksToDelete.length === 0) return;

        const confirmed = await showConfirmModal(`${racksToDelete.length} adet rafı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.`);
        if (!confirmed) return;

        try {
            const btn = document.getElementById('confirmBulkDeleteBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 text-white inline shadow-none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Siliniyor...';

            const response = await fetch('/api/racks/bulk', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rack_ids: racksToDelete })
            });

            if (response.ok) {
                window.showToast('Seçilen raflar başarıyla silindi.', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const data = await response.json();
                window.showToast('Hata: ' + (data.detail || 'Raflar silinemedi.'), 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            window.showToast('Bir hata oluştu: ' + error.message, 'error');
        }
    }

    // Bulk Add Submit Logic
    document.getElementById('addRackForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const raf_adi = document.getElementById('raf_adi').value.trim();
        const sayi = parseInt(document.getElementById('sayi').value);

        if (!raf_adi || !sayi || sayi < 1) {
            window.showToast('Lütfen geçerli bir grup ismi ve sayı giriniz.', 'error');
            return;
        }

        try {
            const response = await fetch('/api/racks/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ raf_adi: raf_adi, sayi: sayi })
            });

            if (response.ok) {
                const racks = await response.json();
                window.showToast(`${racks.length} adet raf başarıyla işlendi.`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const data = await response.json();
                window.showToast('Hata: ' + (data.detail || 'İşlem başarısız oldu.'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            window.showToast('Bir ağ hatası veya sunucu hatası oluştu.', 'error');
        }
    });
</script>
{% endblock %}